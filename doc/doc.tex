\documentclass[letterpaper]{book}

\usepackage[dvips]{graphicx}
\usepackage{epsfig} % for epsfig
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{graphicx}
\usepackage[usenames]{color}
%\graphicspath{{figures/}}

\newcommand{\dt}{\ensuremath{\delta t}}
\newcommand{\ddt}[1]{\frac{\partial #1}{\partial t}}
\newcommand{\thimp}{\ensuremath{\theta}}

\newcommand{\order}[1]{\ensuremath{\mathcal{O}(#1)}}

\renewcommand{\vec}[1]{\ensuremath{\mathbf{#1}}}
\newcommand{\tensor}[1]{\mathsf{#1}}
\newcommand{\tor}{\varphi}              % toroidal coordinate
\newcommand{\A}{\vec{A}}
\newcommand{\B}{\vec{B}}
\newcommand{\E}{\vec{E}}
\newcommand{\R}{\vec{R}}
\newcommand{\x}{\vec{x}}
\renewcommand{\r}{R}
\renewcommand{\v}{\vec{v}}
\renewcommand{\u}{\vec{u}}
\newcommand{\F}{\vec{F}}
\renewcommand{\j}{\vec{J}}
\newcommand{\q}{\vec{q}}
\newcommand{\g}{\vec{g}}
\newcommand{\jn}{\frac{\j}{n}}
\renewcommand{\P}{\tensor{\Pi}}
\renewcommand{\b}{\vec{b}}
\newcommand{\W}{\tensor{W}}
\newcommand{\codename}{\textsc{M3D-$C^1$}}

\newcommand{\grad}[1]{\nabla #1}
\newcommand{\gradp}[1]{\nabla_\perp #1}
\renewcommand{\div}[1]{\nabla \cdot #1}
\newcommand{\divp}[1]{\nabla_\perp \cdot #1}
\newcommand{\curl}[1]{\nabla \times #1}

\newcommand{\dotdot}{:}
\newcommand{\dottimes}{\dot\times}
\newcommand{\timestimes}{\stackrel{\times}{\times}}

\newcommand{\gs}[1]{\Delta^* #1}
\newcommand{\lp}[1]{\nabla^2 #1}
\newcommand{\pb}[2]{\left[#1,#2\right]}
\newcommand{\ip}[2]{\left\langle  #1,#2\right\rangle}
\newcommand{\funcss}[2]{
  \left\langle\left\langle #1,#2 \right\rangle\right\rangle}
\newcommand{\funcsa}[2]{\left[\left\langle #1,#2 \right\rangle\right]}
\newcommand{\funcaa}[2]{\left[\left[ #1,#2 \right]\right]}

\newcommand{\cola}[1]{\textcolor{Red}{#1}}
\newcommand{\colb}[1]{\textcolor{Blue}{#1}}

\newcommand{\uvec}[1]{\ensuremath{\vec{\hat{#1}}}}
\newcommand{\n}{\ensuremath{\uvec{n}}}


\newcommand{\repositoryloc}{portal.pppl.gov/p/tsc/C1/svn}
\newcommand{\svnurl}{http://subversion.tigris.org/}

\title{\codename\ User's Guide}
\author{Nathaniel M. Ferraro}

\begin{document}

\maketitle

\tableofcontents


\chapter{Building and Running \codename}

\section{Obtaining the code}

The source code for \codename\ is in an SVN repository.  To place a
local copy of the current version of \codename\ in the current working
directory, run the command:
\begin{verbatim}
  svn co svn+ssh://username@portal.pppl.gov/p/tsc/C1/svn .
\end{verbatim}
where \texttt{username} should be replaced with your username on the
\texttt{portal.pppl.gov} system.  You may be asked for your password
more than once.

If you have already downloaded a copy of the code, you may update to
the most recent version of the code by running
\begin{verbatim}
  svn update
\end{verbatim}
in the code directory.  Complete documentation on using SVN can be
found at \svnurl.

\section{Building}

The the local copy of the source code is divided into four
directories: \texttt{structured}, \texttt{unstructured},
\texttt{common}, and \texttt{Util}.  To build the code, first
\texttt{cd unstructured}, and then run \texttt{make}.  The following
options may be specified on the command line:
\begin{tabular}{lp{3.5in}}
  \texttt{OPT=1} & Include optimization flags in the compilation.\\
  \texttt{COM=1} & Build the complex version.\\
  \texttt{3D=1}  & Build the 3D version.\\
  \texttt{MAX\_PTS=}$x$ & Set the maximum number of numerical quadrature
  points to $x$ (default is $x=25$ in 2D or $x=125$ in 3D).
\end{tabular}\\
All of these options other than \texttt{MAX\_PTS} are off by
default. \texttt{COM=1} and \texttt{3D=1} are mutually exclusive; if
both are included, \texttt{3D=1} will take precedence.  For example,
to build the optimized 3D version, run
\begin{verbatim}
make OPT=1 3D=1
\end{verbatim}

The executable is built in a directory named named in the following way:
\begin{quote}
  \_\textit{os}-\textit{arch}[-complex\textbar-3d][-opt]-$x$/
\end{quote}
Here \textit{os} is a string identifying the operating system (as
returned by \texttt{uname -s}) and \textit{arch} is a string
identifying the processor architecture (as returned by \texttt{uname
  -p}).  $x$ is the argument of \texttt{MAX\_PTS} as specified in the
\texttt{make} command line.  For example, the executable built on a
Linux system with a 64-bit x86 processor with the command
\texttt{make OPT=1 3D=1} will be placed in the
directory \texttt{\_Linux-x86\_64-3d-opt-125/}.

Object files generated by a particular build may be deleted by running
\texttt{make clean}.  For example, to remove the object files
generated by building the optimized 3D version, run
\begin{verbatim}
  make OPT=1 3D=1 clean
\end{verbatim}


\section{Mesh Generation}

\codename\ requires three files to be present in the working directory
to run: \texttt{C1input}, \texttt{struct.dmg}, and
\texttt{struct-dmg.sms}.

The files \texttt{struct.dmg} and \texttt{struct-dmg.sms} define the
simulation domain boundary shape and the mesh.  Files defining a
rectangular simulation domain with a uniform disribution of nodes may
be created using
\begin{enumerate}
\item Change directories to \texttt{Util}.
\item Build the \texttt{structMesh.x} program by 
  \begin{verbatim}
    g++ structMesh.cc -o structMesh.x
  \end{verbatim}
\item Generate \texttt{struct.sms} by
  \begin{verbatim}
    structMesh.x <nx> <nz> <lx> <lz>
  \end{verbatim}
  where \texttt{<nx>} and \texttt{<nz>} are the number of nodes in the
  $R$ and $Z$ directions, and \texttt{<lx>} and \texttt{<lz>} are the
  dimensions of the simulation domain.
\item Run 
  \begin{verbatim}
    /p/SCOREC/develop/mctk/Examples/PPPL/PPPL/test/main struct.sms
  \end{verbatim} 
  This will create the \texttt{struct.dmg} and \texttt{struct-dmg.sms}
  files.
\item Copy these files to the directory where the \codename\ will be
  run.
\end{enumerate}

\texttt{C1input} contains the input parameters which define all other
options for the physical model and numerical methods used by
\codename\ at run time.  Sample \texttt{C1input} file may be found in
\texttt{unstructured/DATA}.  The options which may be set in
\texttt{C1input} are listed in section~\ref{sec:input_parameters}.


\section{Running}


\section{Restart Options}

Each time the field output is written, restart files are also written.
If \texttt{iglobalout=1}, then a single output file,
\texttt{C1restart}, is written.  Otherwise, each process writes its
own restart file, \texttt{C1restart\#\#\#\#\#}, where
\texttt{\#\#\#\#\#} is the index of the process.  Each time the
restart files are written, the restart files from the previous output
are moved to \texttt{C1restart(\#\#\#\#\#)o}.  \codename\ may be
initialized with these restart files by setting \texttt{irestart=1}.
If the restart file was written with \texttt{iglobalout=1}, then
\texttt{iglobalin=1} must also be set, and the number of processes
used need not be the same as that used when the restart file was
written.  Otherwise, \texttt{iglobalin=0} must be set, and
\codename\ must be run using the same number of processes as when the
restart files were written.


\section{Adapted Meshes}

Currently mesh adaptation is possible only for serial (single process)
runs.  

\paragraph{To adapt the mesh to the initial conditions}:
\begin{enumerate}
\item Set \texttt{ntimemax=0}, \texttt{ntimepr=1}, and
  \texttt{iadapt=1} in \texttt{C1input}.
\item Run \codename\ using a single process.  
\item Rename \texttt{adapted.sms0.sms} to \texttt{struct-dmg.sms}.
\item Set \texttt{iadapt=0}, and change the other options to whatever
  is desired.  
\item The simulation may now be run as normal.
\end{enumerate}

\paragraph{To adapt the mesh to the fields resulting from a simulation:}
\begin{enumerate}
\item Run the simulation with \texttt{iglobalout=1} and
  \texttt{iadapt=0}.
\item When the simulation is complete, set \texttt{iglobalin=1},
  \texttt{irestart=1}, and \texttt{iadapt=1}.
\item Restart the simulation on one process without increasing the
  value of \texttt{ntimemax} or \texttt{ntimepr}.
\item Rename \texttt{adapted.sms0.sms} to \texttt{struct-dmg.sms}.
\item Set \texttt{iadapt=0}, and change the other
  options to whatever is desired.
\item The simulation may now be run as normal.  The simulation may be
  restarted from the stopping point with the new mesh using many
  processes as desired with the new mesh by leaving
  \texttt{irestart=1} and \texttt{iglobalin=1}.
\end{enumerate}

\chapter{Defining Equilibria}

\section{Reading EFIT ``g'' files}

The equilibrium fields may be defined by intepolating data from an
EFIT equilibrium ``g'' file by the following procedure:

\begin{enumerate}
\item Place the EFIT ``g'' file in the working directory, and rename
  it \texttt{geqdsk}.
\item Set \texttt{iread\_eqdsk=1}.
\end{enumerate}

Depending on the resolution of the ``g'' file, the interpolated data
may or may not be smooth enough for accurate linear calculations.  The
interpolated data may be refined using the built-in Grad-Shafranov
solver, as discussed in section~\ref{sec:gs_efit}.


\section{The Grad-Shafranov Solver}

\codename\ contains a Grad-Shafranov solver which may be used to
compute Grad-Shafranov equilibria.  Analytic pressure and toroidal
field profiles may be used, or these profiles may be imported from a
file.  If invoked, this solver is executed, and the results stored as
the equilibrium fields, before any physical time steps are carried
out.

\subsection{Examples}

\subsubsection{Refining an EFIT equilibrium}
\label{sec:gs_efit}

When an equilibrium file is read, the interpolated data may not be the
optimal solution to the Grad-Shafranov equation on \codename's finite
element basis.  The Grad-Shafranov solver may be used to improve the
solution by using the interpolated data as an initial guess, and
proceeding to calculate the Grad-Shafranov solution in the ususal way,
holding the boundary conditions obtained from the interpolated data
fixed.  For example, when reading in an EFIT equilibrium, the following
procedure should be used:

\begin{enumerate}
\item The EFIT ``g'' file should be placed in the working directory,
  and named \texttt{geqdsk}.
\item Set \texttt{iread\_eqdsk=1}
\item If there is an active x-point in the equilibrium, set
  \texttt{xnull} and \texttt{znull} to the approximate position of the
  x-point.
\item If there is an internal limiter (\emph{i.e.} a limiter within
  the computational domain) set \texttt{xlim} and \texttt{zlim} to the
  position of this limiter.  Otherwise, set \texttt{xlim=0} and
  \texttt{zlim=0}.
\item Set \texttt{igs} to a number greater than 0 (30 is typical).
\end{enumerate}

The LCFS will be chosen to be the flux surface closest to the magnetic
axis which is within the separatrix (if present), is within the
internal limiter (if present), and does not intersect the
computational domain boundary (\textit{i.e.} the domain boundary is
considered to be a physical limiter).


\section{Non-Axisymmetric Coils}

Fields from non-axisymmetric coils may be added to the initial
conditions in the following way.  Presently, nonaxisymmetric currents
having a single toroidal mode number are supported.

\begin{enumerate}
\item Coil positions and currents should be defined in the files
  \texttt{rmp\_coil.dat} and \texttt{rmp\_current.dat}, respectively.
\item Set \texttt{ntor} to be the toroidal mode number of the
  nonaxisymmetric currents.
\item To have the resulting fields superimposed on the initial
  conditions throughout the domain, set \texttt{irmp=1}.
\item To have the resulting fields superimposed on the initial
  conditions only at the boundaries, set \texttt{irmp=2}.
\end{enumerate}


\section{Random Perturbations}



\chapter{Model}

\section{Extended-MHD}

The extended-MHD model consists of the following equations:
\begin{subequations} \label{eq:xmhd}
\begin{eqnarray}
  \label{eq:continuity}
  \ddt{n} + \div n \u & = & D,
  \\
  \label{eq:momentum}
  n \left( \ddt{\u} + \u \cdot \nabla \u \right) 
  & = & \j \times \B - (\nabla p + \div \P) + \R + \F - \u D,
  \\
  \frac{1}{\Gamma-1} \left( \ddt{p} + \div{p\u} \right)
  & = & -p \div\u +
  \frac{d_i}{\Gamma-1}\jn\cdot\left(\nabla p_e -
  \Gamma \frac{p_e}{n}\nabla n \right)
  \\ & & \mbox{}
  - \div{\q} + Q - \P\dotdot\nabla \u + d_i \P_e\dotdot\nabla \jn + \frac{1}{2} u^2 D,
  \nonumber \\
  \frac{1}{\Gamma-1} \left( \ddt{p_e} + \div{p_e\u} \right)
  & = & -p_e \div\u +
  \frac{d_i}{\Gamma-1}\jn\cdot\left(\nabla p_e -
  \Gamma \frac{p_e}{n}\nabla n \right)
  \\ & & \mbox{} 
  - \div{\q_e} + Q_e - \P_e\dotdot\nabla \u + d_i \P_e\dotdot\nabla \jn,
  \nonumber 
  \\
  \label{eq:Faraday}
  \ddt{\B} & = & -\curl \E,
  \\
  \j & = &\curl \B,
  \\
  \label{eq:ohm}
  \E + \u \times \B & = &  
  \frac{d_i}{n} \left(\j\times\B - \nabla p_e 
  - \div{\P_e} + \R + \F \right)
\end{eqnarray}
\end{subequations}

\subsection{Units}

Quantities are given in a system of non-dimensional usits determined
by three independent, arbitrary characteristic quantities: $n_0$, the
characteristic number density; $L_0$, the characteristic length scale;
and $B_0$, the characteristic magnetic field strength.  From these
quantities, the characteristic Alfv\'en velocity and Alfv\'en time are
defined, respectively, as
\begin{eqnarray}
  v_{A 0} & = & \frac{B_0}{\sqrt{4\pi m_i n_0}}\\
  \tau_{A 0} & = & \frac{L_0}{v_{A 0}}
\end{eqnarray}

Variables in \codename\ use the following system of units:

\begin{tabular}{lcrl}
  \textbf{Variable} & \textbf{Unit}              &  \textbf{Default} &\\
  \hline
  Current           & $c B_0 L_0 / 4\pi$         & 796       & kA\\
  Current Density   & $c B_0 / 4\pi L_0$         & 796       & kA/m$^2$\\
  Diffusivity       & $L_0^2/\tau_{A 0}$         & $2.18\times10^6$ & m$^2$/s\\
  Electric Field    & $v_{A 0} B_0/c$            & 2180      & kV/m\\
  Frequency         & $v_{A 0}/L_0$              & 2180      & kHz\\
  Length            & $L_0$                      & 1         & m \\
  Magnetic Field    & $B_0$                      & 1         & T\\
  Number Density    & $n_0$                      & $10^{20}$ & m$^{-3}$\\
  Potential         & $L_0 v_{A 0} B_0/c$        & 2180      & kV\\
  Pressure          & $B_0^2/4\pi$               & 7.85      & atm\\
  Resistivity       & $4\pi v_{A 0} L_0/c^2$     & 2.74      & $\Omega$ m\\
  Temperature       & $B_0^2/4\pi n_0$           & 40.1      & keV\\
  Velocity          & $v_{A 0}$                  & 2180      & km/s\\
  Viscosity         & $m_i n_0 L_0^2/\tau_{A 0}$ & 0.365     & kg/m s
\end{tabular}\\
where the ``default'' values are calculated using the default
characteristic quantities: $n_0 = 10^{14}$ cm$^{-3}$, $L_0 = 100$ cm,
and $B_0 = 10^4$ G.

\section{Weak Form}

\subsection{Density Equation}

\begin{equation}
  \nu \ddt{n} = 
  n \u \cdot \grad{\nu} 
  + \nu D 
  - (\nu n \u \cdot \grad{\tor})_\tor
  - \divp{(\nu n \u)}
\end{equation}

\subsection{Vorticity Equation}

\begin{eqnarray}
  -\nu \grad{\tor} \cdot \curl{(R^2 n \u)}
  & = & - R^2 n \u \cdot (\grad{\nu} \times \grad{\tor})
  + R^2 (\nu n \grad{\tor} \times \u)_\tor \\ \nonumber & & \mbox{}
  + \divp{(R^2 \nu n \grad{\tor} \times \u)}
\end{eqnarray}

\subsection{Toroidal Velocity Equation}

\subsection{Compression Equation}

\subsection{Pressure Equation}

\subsection{Poloidal Flux Equation}

\begin{equation}
  \ddt \A = -\E - \grad{\phi}
\end{equation}

\begin{eqnarray}
\lefteqn{ -R^2 \nu \grad{\tor} \cdot \ddt \A = } \\
 & & -R^2 \nu \grad{\tor} \cdot \left\{
  -\grad{\phi} - \u \times \B 
  + \frac{d_i}{n} \left(\j \times \B - \grad{p_e} + \R + \F \right) \right\}
  \\ \nonumber & & \mbox{} 
  - \P_e : \grad{\left(\frac{d_i}{n} R^2 \nu \grad{\tor} \right)}
  + \left(\frac{d_i}{n} R^2 \nu \grad{\tor} \cdot \P_e \cdot
  \grad{\tor} \right)_\tor
  \\ \nonumber & & \mbox{}
  + \divp{\left(\frac{d_i}{n} R^2 \nu \grad{\tor} \cdot \P_e \right)}
\end{eqnarray}

\subsection{Toroidal Current Density Equation}

\begin{eqnarray}
  -\nu \grad{\tor} \cdot \curl{\ddt \B} & = & 
  \nu \grad{\tor} \cdot \curl{\curl{\E}}
  \\ \nonumber
   & = & 
  - \gs{\nu} \curl{\E} \cdot \grad{\tor}
  + \left[ \grad{\tor} \cdot \E \times (\grad{\nu} \times \grad{\tor})
    \right]_\tor
  \\ \nonumber & & \mbox{}
  + \divp{\left[ \E \times (\grad{\nu} \times \grad{\tor})
  - \nu \grad{\tor} \times \curl{\E} \right]}
\end{eqnarray}

\subsection{Toroidal Field Equation}

\begin{eqnarray}
  \nu \grad{\tor} \cdot \ddt{\B} & = &
  -(\grad{\nu} \times \grad{\tor}) \cdot \E
  + \divp{(\nu \grad{\tor} \times \E)} 
  \\ \nonumber & = &
  -(\grad{\nu} \times \grad{\tor}) \cdot \left\{
  -\u \times \B + \frac{d_i}{n} \left(
  \j \times \B - \grad{p_e} + \R + \F \right) \right\}
  \\ \nonumber & & \mbox{}
  - \P_e : \grad{ \left( \frac{d_i}{n} \grad{\nu} \times \grad{\tor}
    \right)}
  + \left[ \frac{d_i}{n} (\grad{\nu} \times \grad{\tor}) \cdot \P_e
  \cdot \grad{\tor} \right]_\tor
  \\ \nonumber & & \mbox{}
  + \divp{\left[\frac{d_i}{n} (\grad{\nu} \times \grad{\tor}) \cdot
      \P_e \right]} + \divp{(\nu \grad{\tor} \times \E)}
\end{eqnarray}

\section{Scalar Form}

Without loss of generality, the vector potential may be written
\begin{equation}
  \A = R^2 \grad{\tor} \times \grad{f} + \psi \grad{\psi},
\end{equation}
which obtains the magnetic field
\begin{equation}
  \B = \grad{\psi} \times \grad{\tor} + R^2 \lp{f} xc\grad{\tor} -
  \gradp{f_\tor}.
\end{equation}

In cylindrical coordinates, the velocity may be written as
\begin{equation}
  \u = R^2 \grad{U} \times \grad{\tor} 
  + R^2 \omega \grad{\tor}
  + \frac{1}{R^2}\grad{\chi}.
\end{equation}
This form has the advantage that $U$ purely advects the toroidal
component of the magnetic field, and therefore velocities which
manifestly do not compress the toroidal field may be represented.
Expressions for the individual scalar components of $\u$ may be
obtained by acting on $\u$ with the operators
\begin{subequations}
\begin{eqnarray}
  & \grad{\tor} \cdot \curl{(R^2 \u)} & \\
  &  R^2 \grad{\tor} \cdot \u & \\
  &  \divp{\left(\frac{\u}{R^2}\right)} &
\end{eqnarray}
\end{subequations}

\subsection{Density Equation}

\subsubsection{Volume Terms}

\begin{equation}
  \nu \ddt{n} = 
  R^2 n \pb{\nu}{U} 
  - \nu (n \omega)_\tor
  + \frac{1}{R^2} n \ip{\nu}{\chi} 
  + \nu D
  - \divp{(\nu n \u)}
\end{equation}

\subsubsection{Surface Terms}

\begin{equation}
  \n \cdot (\nu n \u) = \nu n \n \cdot \u
\end{equation}


\subsection{Vorticity Equation}

\begin{eqnarray}
  \lefteqn{-\nu \grad{\tor} \cdot \curl{(R^2 n \u)} = }\\
  & & -\pb{\nu}{\psi}\gs{\psi} + \ip{\nu}{f_\tor}\gs{\psi}
      -\frac{1}{R^2} F \ip{\nu}{\psi_\tor}
      -F \pb{\nu}{f_{\tor \tor}}\\
  & & \mbox{} R^2 n \left\{ R^2 \pb{\nu}{U} \lp{U}
      + \frac{1}{2} \pb{R^2 \ip{U}{U}}{\nu}
      + \omega \ip{\nu}{U_\psi} + \nu_Z \omega^2
      - \frac{1}{R^2} \pb{nu}{\chi_\tor} \right\}
\end{eqnarray}


\subsection{Scalar Form}

\subsubsection{Scalar Operator Definitions}

The ``Poisson bracket'' and ``inner product'' operators
are defined as
\[ 
\pb{a}{b} = \nabla \tor \cdot \grad{a} \times \grad{b}, 
\quad
\ip{a}{b} = \grad{a} \cdot \grad{b}
\]
and the Grad-Shafranov operator is
\[
\gs{a} = R^2 \div{\left(\frac{\grad{a}}{R^2}\right)}.
\]
When dealing with tensors, the following bilinear operators are often
useful:
\begin{eqnarray*}
  \tensor{a} \dotdot \tensor{b} & = & a_{i j} b_{i j}
  \\
  (\tensor{a} \dottimes \tensor{b})_i & = & \epsilon_{i j k}
  a_{l j} b_{l k}
  \\
  (\tensor{a} \timestimes \tensor{b})_{i j} & = & 
  \epsilon_{i k l} \epsilon_{i m n} a_{k m} b_{l n},
\end{eqnarray*}
where sums over repeated indices are implicit, and $\tensor{\epsilon}$
is the fully anti-symmetric Levi-Civita tensor.  Also useful are the
following bilinear second-order differential operators based on the
above binary operators:
\begin{eqnarray*}
  \funcss{a}{b} & = & \grad{\grad{a}} \dotdot \grad{\grad{b}} \\
  \funcsa{a}{b} & = & \grad{\tor} \cdot 
  \grad{\grad{a}} \dottimes \grad{\grad{b}}\\
  \funcaa{a}{b} & = & \grad{\tor} \cdot 
       \grad{\grad{a}} \timestimes \grad{\grad{b}}
       \cdot \grad{\tor}.
\end{eqnarray*}

\subsubsection{Scalar Equations}


The magnetic and velocity fields are written flux/potential form:
\[
\B = \grad{\psi} \times \grad{\tor} + F \grad{\tor},
\quad
\u = \grad{U} \times \grad{\tor} + V \grad{\tor} + \grad{\chi}.
\]
To get time-evolution equations for the scalar components of the
velocity and magnetic field, one may act upon the momentum equation
and Faraday's Law (equations (\ref{eq:momentum}) and
(\ref{eq:Faraday})) with the operators
\begin{subequations}
  \label{eq:operators}
  \begin{eqnarray}
    -R^2 \grad{\tor} \cdot \curl{\mbox{}},\quad 
    R^2 \grad{\tor} \cdot \mbox{},\quad \mbox{and }
    \div{\mbox{}}.
  \end{eqnarray}
\end{subequations}
This yields
\begin{subequations}
  \label{eq:scalar_equations}
\begin{eqnarray}
  \label{eq:scalar_n}
  \cola{\dot{n}} & \cola{=} & \cola{-\pb{n}{U}} - \ip{n}{\chi} 
  - n \lp{\chi} + \cola{D_n \lp{n}}
  \\
  \label{eq:scalar_p}
  \dot{p} & = & - \pb{p}{U} - \ip{p}{\chi} - \Gamma p \lp{\chi} 
  - \frac{1}{n}\pb{F}{p_e} - \Gamma p_e \pb{F}{\frac{1}{n}} 
  \\ & & \mbox{} + (\Gamma-1) (Q - \div\q )
  \nonumber \\
  \label{eq:scalar_pe}
  \dot{p_e} & = & - \pb{p_e}{U} - \ip{p_e}{\chi} - \Gamma p_e \lp{\chi} 
  - \frac{1}{n}\pb{F}{p_e} - \Gamma p_e \pb{F}{\frac{1}{n}} 
    \\ & & \mbox{}
  + (\Gamma-1) (Q_e - \div\q_e)
  \nonumber \\
  \label{eq:scalar_psi}
  \cola{\dot{\psi}} & \cola{=} & \cola{-\pb{\psi}{U}} - \ip{\psi}{\chi} 
  + \colb{\frac{1}{n}\pb{\psi}{F}}
  + \cola{\eta \gs{\left(\psi - \lambda_B \gs{\psi} \right)}}
  \\
  \label{eq:scalar_F}
  \colb{\dot{F}} & \colb{=} & \colb{- R^2 \pb{\frac{F}{R^2}}{U} 
    - R^2 \pb{\psi}{\frac{V}{R^2}}} - F \gs{\chi} - \ip{F}{\chi}
   \\ && \mbox{}
  + \colb{R^2\pb{\frac{\gs{\psi}}{R^2 n}}{\psi}
    + \frac{R^2}{2} \pb{\frac{1}{R^2 n}}{F^2}}
  + R^2 \pb{\frac{1}{n}}{p_e}  \nonumber \\ && \mbox{}
  + \colb{\eta \gs{\left(F - \lambda_B \gs{F} \right)}
    + \ip{\eta}{F - \lambda_B \gs{F}}} 
  \nonumber \\
  \label{eq:scalar_U}
  \lefteqn{\cola{n \gs{\dot{U}} + \ip{n}{\dot{U}}} - R^2
  \pb{n}{\dot{\chi}}}\\
  & = &
  \cola{R^2 \pb{\frac{\gs{\psi}}{R^2}}{\psi}} 
  + \colb{\frac{\left(F^2 \right)_Z}{R^2}}
  - \cola{R^2 \pb{n \frac{\gs{U}}{R^2}}{U}
    - \frac{R^2}{2} \pb{\frac{\ip{U}{U}}{R^2}}{n}} \nonumber \\ && \mbox{}
  - \colb{\frac{\left(n V^2 \right)_Z}{R^2}}
  - \ip{n \gs{U}}{\chi} - n \gs{U}\gs{\chi}
  - R^2 \pb{n}{\pb{U}{\chi}} \nonumber \\ && \mbox{}
  - \frac{1}{2} \pb{\ip{\chi}{\chi}}{n} 
  - \cola{D \gs{U} -\ip{D}{U}} + R^2 \pb{D}{\chi}
  \nonumber \\ &&
  \cola{\mbox{} - R^2 \grad{\tor} \cdot \curl{(\F - \div \P)}}\nonumber
  \\
  \label{eq:scalar_vz}
  \colb{n \dot{V}} & \colb{=} & \colb{\pb{F}{\psi} - n \pb{V}{U}} 
  - n\pb{V}{\chi}
  - \colb{D V + R^2 \grad{\tor} \cdot (\F - \div\P)}
  \\
  \label{eq:scalar_chi}
  \lefteqn{n \gs{\dot{\chi}} + \ip{n}{\dot{\chi}} + \pb{n}{\dot{U}}} \\ 
  & = & - \lp{p} - \frac{1}{R^2} \left[(\gs{\psi})^2 +
  \ip{\gs{\psi}}{\psi} \right]
  - \frac{1}{2 R^2}\gs{\left(F^2\right)} \nonumber  \\ && \mbox{}
  + \frac{1}{R^2} \left[ n (\gs{U})^2 + \ip{n \gs{U}}{U} \right]
   \nonumber \\ && \mbox{} 
  - \frac{1}{2} \left[n\lp{\left(\frac{\ip{U}{U}}{R^2}\right)}
    + \ip{n}{\frac{\ip{U}{U}}{R^2}} \right] \nonumber \\ && \mbox{}
  + \frac{1}{R}\left(\frac{n V^2}{R^2}\right)_r 
  - n \lp{\pb{\chi}{U}}
  - \pb{n \gs{U}}{\chi} + \ip{n}{\pb{U}{\chi}}
   \nonumber \\ && \mbox{}
  - \frac{1}{2} \left(n \ip{\chi}{\chi} + \ip{n}{\ip{\chi}{\chi}}
  \right)
  -\pb{D}{U} - D \lp{\chi} - \ip{D}{\chi} \nonumber \\
  && \mbox{} + \div(\F - \div\P) \nonumber
  \nonumber
\end{eqnarray}
\end{subequations}
In the above, it has been assumed that the electron pressure tensor
$\P_e$ is of the form specified in
equation~(\ref{eq:electron_pressure_tensor}).  For compactness, the
terms involving the ion pressure tensor $\P$, the heat flux density
$\q$, the heat flux $Q$, and the external force $\F$ have not been
expanded in the above equations.  The expanded, scalar forms of these
terms are given in sections~\ref{sec:transport_coefficients} and
\ref{sec:phenom_models}.

\section{Reduced Models}

The full extended-MHD equations contain as subsets simpler, fully
consistent, energy-conserving (up to dissipative terms) fluid models.
Because of the flux/po\-ten\-tial repreresentation of the fields,
these models may be obtained simply by dropping some of the scalar
equations from the full system.  Specifically, by dropping the
density, pressure, electron pressure and compression equations, the
four-field model of Fitzpatrick and Porcelli~\cite{Fitzpatrick04} is
recovered.  This model is represented by the terms in blue and red,
and may be chosen by setting \texttt{numvar=2}.  By also dropping the
axial field and axial velocity equations, a two-field model
appropriate in the low-$\beta$, high axial field limit is recovered
(indicated by red terms).  This model may be chosen by setting
\texttt{numvar=1}.  Setting \texttt{numvar=3} advances all three
velocity components, both magnetic field components, and the pressure.

For any choice of \texttt{numvar}, The particle density equation may
or may not be included by setting \texttt{idens=1} or \texttt{0},
respectively.  If \texttt{numvar=3}, the electron pressure equation is
included by setting \texttt{ipres=1}.


\section{Transport Coefficients \label{sec:transport_coefficients}}


\subsection{Density Source $D$}

The density source term is assumed to have the form of a density
diffusion, with some arbitrary density source
\begin{eqnarray}
  D = D_n \nabla^2 n + \sigma.
\end{eqnarray}


\subsection{Collisional Force $\R$}

The collisional force is assumed to be of the form
\begin{equation}
  \label{eq:collisional_force}
  \R = n \eta \j.
\end{equation}


\subsection{Pressure tensor $\P$ \label{sec:pressure_tensor}}
A total pressure tensor of the form
\begin{equation}
  \P = \P_\parallel + \P_\times + \P_\circ
\end{equation}
is assumed, where $\P_\parallel$ and $\P_\times$ are respectively
Braginskii's form of the parallel viscosity and gyroviscosity.
$\P_\circ$ is a general isotropic viscosity, which is not present in
Braginskii's model for a magnetized plasma.
\begin{eqnarray}
  \label{eq:parallel_viscosity}
  \P_\parallel & = & \mu_\parallel   \left( \b \cdot \W \cdot \b \right)
  \left( \tensor{F} - 3 \b \b \right)
  \\
  \label{eq:gyroviscosity}
  \P_\times & = & \frac{p_i}{4 \omega_{c i}} \left\{
    \b \times \W \cdot (\tensor{F} + 3 \b\b) +
    \left[\b \times \W \cdot (\tensor{F} + 3 \b\b)\right]^\top
    \right\}
  \\
  \label{eq:general_viscosity}
  \P_\circ & = & -\mu \left(\grad{\u} + \grad{\u}^\top\right)
   -2 \left(\mu_c - \mu \right)\ \tensor{F}\ \div{\u}.
\end{eqnarray}
The rate-of-strain tensor is
\begin{displaymath}
  \W = \nabla \u + (\nabla \u)^\top 
  - \frac{2}{3}\ \tensor{F}\ \div{\u}
\end{displaymath}
and where, in the Braginskii model,
\begin{eqnarray*}
  \mu_\parallel = \eta_0 \frac{p_i \tau_i}{2} 
  \\
  \eta_0 \approx 0.96.  
\end{eqnarray*}
The choice of values for the general dissipative viscosity
coefficients $\mu$ and $\mu_c$ is constrained by the positivity
conditions $\mu > 0$ and $\mu_c > (2/3)\mu$.

For the isotropic viscosity, it is found that
\begin{eqnarray*}
  -\div{\P_\circ} = \mu \lp{\u} + \ip{\mu}{\u} + \ip{\u}{\mu}
  + (2 \mu_c - \mu) \grad{(\div{\u})}
\end{eqnarray*}
and
\begin{eqnarray}
   R^2 \grad{\tor} \cdot \curl{\div \P^d} & = & 
   \gs{(\mu \gs{U})} - 2 R^2 \funcaa{\mu}{U} + 2\pb{\mu_Z}{U}
   \\ \nonumber && \mbox{} 
   - 2 R^2 \left( \funcsa{\mu}{\chi} + \pb{\mu}{\lp{\chi}} \right)
   \\
   -R^2 \grad \tor \cdot \div \P^d & = & \mu \gs{V} 
   + R^2 \ip{\mu}{\frac{V}{R^2}}
   \\
   -\div \div \P^d & = & 2 \left\{ \lp{(\mu_c \lp{\chi})} 
   + \funcss{\mu}{\chi} - \lp{\mu}\lp{\chi}
   \right. \\ && \left. \nonumber \mbox{}
   + \funcsa{\mu}{U} + \pb{\mu}{\gs{U}} - \pb{\frac{\mu_R}{R}}{U} 
   \right\}.
\end{eqnarray}

\subsubsection{Viscous Heating}

The viscous heating associated with the above form of the ion pressure
tensor is
\begin{eqnarray}
  - \P_\circ \dotdot \grad{\u} & = & 2 \mu \left\{
    \frac{1}{2 R^2} (\gs{U})^2 
    - \funcaa{U}{U} + \frac{2}{R} \pb{U}{\pb{R}{U}}
    \right. \\ \nonumber & & \left. \mbox{} 
    - 2 \funcsa{U}{\chi} + 2 \pb{U}{\frac{\ip{R}{\chi}}{R}}
    \right. \\ \nonumber & & \left. \mbox{}
    + \frac{R^2}{2} \ip{\frac{V}{R^2}}{\frac{V}{R^2}}
    + \funcss{\chi}{\chi} \right\}
  + 2 (\mu_c - \mu) (\lp{\chi})^2
\end{eqnarray}
\begin{eqnarray}
  \lefteqn{-\P_\parallel \dotdot \grad{\u} = - \mu_\parallel
    \left( 1-3 \frac{\ip{\psi}{\psi}}{R^2 B^2} \right) \lp{\chi}}
  \\ && \mbox{}
    - \frac{3 \mu_\parallel}{R^2 B^2} \left( \begin{array}{l}
      \frac{1}{2} R^2 \pb{U}{\frac{\ip{\psi}{\psi}}{R^2}}
      -\ip{\psi}{\pb{U}{\psi}} + \frac{1}{R^2} F^2 \partial_Z U
       \\ \mbox{}
    + R^2 F \pb{\psi}{\frac{V}{R^2}}
       \\ \mbox{}
    - \frac{1}{2}R^2 \ip{\chi}{\frac{\ip{\psi}{\psi}}{R^2}}
    + \ip{\psi}{\ip{\chi}{\psi}} - \frac{1}{R}F^2 \partial_r \chi
    \end{array}    \right)\nonumber
\end{eqnarray}
\begin{equation}
  - \P_\times \dotdot \grad{\u} = 0.
\end{equation}


\subsection{Electron Pressure Tensor $\P_e$ 
  \label{sec:electron_pressure_tensor}}

The electron pressure tensor is assumed to take the form
\begin{equation}
  \label{eq:electron_pressure_tensor}
  \P_e = \lambda \eta n \grad{\j}.
\end{equation}
Physically, this represents an approximation of isotropic electron
viscosity, assuming that $\grad{\u_e} = \grad{(\u - \j/n)} \sim
\grad{\j}/n$ and $\mu_e \sim \lambda \eta n^2$.  Numerically, this
term is effectively a hyper-resistivity, as its inclusion in the
generalized Ohm's law (equation~(\ref{eq:ohm})) results in a
biharmonic operator acting on the magnetic field in Faraday's law.

\subsubsection{Electron Viscous Heating}

The viscous heating of electrons is
\begin{eqnarray}
  \lefteqn{\P_e \dotdot \grad{\frac{\j}{n}} = }
  \\ & &
  \frac{\lambda \eta}{R^2} \left\{ 
  \funcss{F}{F} 
  + \frac{1}{2} R^4 n \ip{\frac{1}{R^2 n}}{\frac{\ip{F}{F}}{R^2}}
  -\frac{2}{R^2} F_R^2
  \nonumber \right. \\ & & \left. \mbox{}
  + R^2 n \ip{\frac{\gs{\psi}}{R n}}{\frac{\gs{\psi}}{R}}
  + \frac{1}{R^2} (\gs{\psi})^2 \right\}.
\end{eqnarray}


\subsection{Heat Flux Density $\q$, $\q_e$}
\label{sec:heat_flux}

The heat flux density allows for general isotropic, parallel, and
crosswise thermal diffusion.
\begin{eqnarray}
  \label{eq:heat_flux}
  \q & = & -\kappa \grad{T} - \kappa_\parallel \b \b \cdot \grad{T} 
  - \kappa_\times \b \times \grad{T} \\
  \q_e & = & -\kappa^e \grad{T_e} - \kappa_\parallel^e \b \b \cdot \grad{T_e}
  - \kappa_\times^e \b \times \grad{T_e}.
\end{eqnarray}
The divergence of the heat flux density, in scalar form, is
\begin{eqnarray}
  -\div \q & = & \kappa \lp{T} + \ip{\kappa}{T} 
  + \pb{\psi}{\kappa_\parallel \frac{\pb{\psi}{T}}{B^2}}
  - \pb{\frac{\kappa_\times F}{B}}{T}.
\end{eqnarray}

\subsection{Resistive Heating $Q$, $Q_e$}

The heating due to resistive friction is:
\begin{eqnarray*}
  Q_e & = & \eta J^2  - Q_\Delta,\\
  Q   & = & \eta J^2.
\end{eqnarray*}
The equipartition term, $Q_\Delta = 3 (m_e/m_i) (p_e - p_i) / \tau_e$,
is due to the flow of heat from the hotter to the cooler specie, and
does not contribute to $Q$.  In scalar form,
\begin{displaymath}
  Q = \frac{1}{R^2} \eta \left[ (\gs{\psi})^2 + \ip{F}{F} \right]
\end{displaymath}


\section{Phenomenological Models \label{sec:phenom_models}}

\subsection{Gravity}

Gravity is implemented separately from other momentum sources in order
that the density factors in the gravity terms may be analytically
expanded in the velocity advance.  This increases the value of the
maximum stable timestep when simulating gravitational instabilities
such as the Rayleigh-Taylor instability.
\begin{equation}
  \label{eq:gravity}
  \F_g = n \g = -\frac{n g_R}{R^2}\uvec{R} - n g_Z \uvec{Z}
\end{equation}
\begin{eqnarray*}
  -R^2 \grad \tor \cdot \curl \F_g & = & \frac{g_r \partial_Z n}{R} 
  - r g_Z \partial_r n,
  \\
  R^2 \tor \cdot \F_g & = & 0,
  \\
  \div{\F_g} & = & - \frac{g_R}{R} \frac{\partial}{\partial_R} \left(
  \frac{n_x}{R} \right) - g_Z \partial_Z n.
\end{eqnarray*}

\subsection{Ohmic Current Drive}

Ohmic current drive is modeled by the application of a
loop voltage $V_L$ at the boundary of the simulation domain.  This is
implemented by ramping up the value of $\psi$ on the boundary at a
constant rate, $\partial_t \psi = V_L/(2 \pi)$.

\subsection{Pellet Injection \label{sec:pellet_injection}}

Pellet injection in \codename is simplistically modeled by the
inclusion of a density source centered at a specified location, $(r_p,
Z_p)$.  The density source is axisymmetric, with a Gaussian poloidal
cross-section, having constant, arbitrary rate ($\alpha_p$) and
variance ($l_p$).  Specfically,
\begin{equation}
  \sigma_p = \frac{\alpha_{p}}{2 \pi l_{p}^2}
  \exp \left[ -\frac{(r-r_p)^2 + (Z-Z_p)^2}{2 l_p^2}\right].
\end{equation}
It is assumed that the injected plasma is cold and stationary, and
therefore there is no associated energy or momentum source.


\subsection{Ionization of neutrals \label{sec:ionization}}

A model simulating the ionization of an ambient neutral gas is
included in \codename as follows.  It is assumed that the density
source due to this ionization takes the form
\begin{equation}
  \sigma_i = \alpha_i \frac{n_n}{n_{n 0}} e^{-E_i / T},
\end{equation}
where $n_n$ is the neutral density, $E_i$ is the ionization energy,
and $\alpha_i$ is a free ionization rate coefficient.  Since the
neutral density is not physically evolved in \codename, it is assumed
that the neutral density is constant in regions where $T < T_0$, and
decreases exponentially with temperature in hotter regions:
\begin{equation}
  n_n =
  \begin{cases}
    n_{n 0} & \text{if $T \le E_i$}\\
    n_{n 0} e^{-(T - E_i) / l_i} & \text{if $T > E_i$}
  \end{cases},
\end{equation}
where $l_i$ is the temperature scale-length of the neutral burn-out.
It is assumed that the newly ionized plasma is cold and stationary,
and therefore there is no associated energy or momentum source.



\subsection{Toroidal Current Controller \label{sec:current_controller}}

In order to reach a steady state, current lost through resistive
dissipation must be offset by some form of current drive.  A feedback
loop which adjusts the rate of current drive in response to changes in
toroidal current allows the toroidal current to be maintained at a
steady level.  A PID (proportional, integral, derivative) controller
is implemented in \codename which accomplishes this by adjusting the
loop voltage $V_L$ at each time step in the following way:
\begin{equation}
  V_L^{(n+1)} = V_L^{(n)} - \dt\, V_L \left\{ c_p (F_p - F_0) + c_i
  \int_0^t dt'\,[F_p(t') - F_0] + c_d \ddt{F_p} \right\},
\end{equation}
where $F_p$ is the total toroidal current and $F_0$ is the target
toroidal current.  The parameters $c_p$, $c_i$, and $c_d$ determine
the response of the feedback loop.


\section{Energy Conservation}

Equations~(\ref{eq:xmhd}) obey the energy density equation
\begin{eqnarray}
 \lefteqn{\ddt{}\left(\frac{1}{2}B^2 + \frac{1}{2}n u^2 + \frac{1}{\Gamma-1}p
  \right)} \nonumber \\ & & \mbox{}+ \div{\left[
      \frac{\Gamma}{\Gamma-1} \left(p \u - d_i p_e \jn\right)
      + \E \times \B + \P \cdot \u - d_i \P_e \cdot \jn
      + \frac{1}{2} n u^2 \u + \q \right]} \nonumber
 \\ & & = \F \cdot \u \label{eq:energy}
\end{eqnarray}

The terms acted upon by the divergence operator represent power
density fluxes.  Integrating equation~(\ref{eq:energy}) over the
volume enclosed by the simulation domain shows that, in the absence of
external work done on the system ($\F \cdot \u$), energy is conserved,
less the power carried out of the volume by these fluxes.  Each of
these power density fluxes is described in the following sections, as
well as their contribution to the overall power flux out of the
boundary under various boundary conditions.

\subsection{Advective Thermal Flux}

The first of the terms within the divergence operator in
equation~(\ref{eq:energy}) represents the advective flux of thermal
energy per unit time.
\begin{equation}
  \frac{\Gamma}{\Gamma - 1} \div \left[ p \u - p_e \frac{\j}{n}
  \right] = \frac{\Gamma}{\Gamma - 1} \left( 
  p \lp\chi + \ip{p}{\chi} + \pb{p}{U} - d_i \pb{T_e}{F} \right)
\end{equation}
The total power flux due to the advective thermal flux is
\begin{eqnarray*}
  \frac{\Gamma}{\Gamma - 1} \int dV\ \div 
  \left( p \u - p_e \frac{\j}{n} \right) 
  & = & \frac{\Gamma}{\Gamma - 1} \int dS\ \uvec{n} \cdot
  \left( p \u - p_e \frac{\j}{n} \right) \\ 
  & = & \frac{\Gamma}{\Gamma - 1} \int dS\ 
  \left( p \uvec{n} \cdot \u - \frac{1}{R} T_e \uvec{t}\cdot \grad F \right).
\end{eqnarray*}
This flux vanishes when both no-normal-flow ($\uvec{n} \cdot \u =
0$) and no-normal-current ($\uvec{n} \cdot \j = \uvec{t} \cdot \grad F
= 0$) boundary conditions are enfoced.

\subsection{Poynting Flux}

The second term represents the flux of electromagnetic energy per unit
time.  In the case where $\E$ is determined by the generalized Ohm's
law, equation~(\ref{eq:ohm}), on the boundary,
\begin{eqnarray}
  \div (\E\times\B) & = & -\frac{1}{R^2} 
  \left[\eta (\gs{\psi})^2 + \ip{\eta \gs\psi}{\psi}
    + \eta F \gs{F} + \ip{\eta F}{F} \right]
  \\ && \mbox{}
  + \frac{1}{R^2}\left(\gs\psi\pb{\psi}{U} 
  + \ip{\pb{\psi}{U}}{\psi} \right)
  + \pb{\frac{F^2}{R^2}}{U}
  \nonumber \\ && \mbox{}
  + \pb{\psi}{\frac{1}{R^2} F V}
  \nonumber \\ && \mbox{}
  + \frac{1}{R^2}\left(\gs\psi\ip{\psi}{\chi}
  + \ip{\ip{\psi}{\chi}}{\psi} \right)
  + \frac{1}{R^2}\left(F^2\gs\chi + \ip{F^2}{\chi}\right)
  \nonumber \\ && \mbox{}
  + F \pb{\psi}{\frac{\gs{\psi}}{R^2 n}}
  + \frac{1}{R^2} \ip{\frac{\pb{F}{\psi}}{n}}{\psi}
  + F^2 \pb{F}{\frac{1}{R^2 n}} 
  + \pb{p_e}{\frac{F}{n}} \nonumber
\end{eqnarray}
where terms due to $\P_e$ have been omitted.  However, if the
boundary conditions are such that $\E = -\frac{V_L}{2 \pi} \grad\tor$
(as is the case with perfectly-conducting boundaries with ohmic
heating), then, on the boundary
\begin{equation}
  \uvec{n} \cdot (\E\times\B) = 
  -\frac{V_L}{2 \pi R^2} \uvec{n} \cdot \grad\psi.
\end{equation}
The total power flux out of boundaries is then
\begin{eqnarray*}
  \int dV\ \div (\E\times\B) 
  & = & \oint dS\ \uvec{n} \cdot (\E\times\B) \\
  & = & -\oint dS\ \uvec{n} \cdot \frac{V_L}{2 \pi R^2} \grad\psi \\
  & = & -\int dV\ \frac{V_L}{2 \pi R^2} \gs\psi\\
  & = & F_p V_L,
\end{eqnarray*}
where $F_p$ is the total toroidal current within the boundaries


\subsection{Advective Kinetic Flux}

The fifth term represents the advective flux of kinetic energy per
unit time.
\begin{eqnarray*}
  \lefteqn{\div \left(\frac{1}{2} n u^2 \u \right)}  \\
  & = & 
  \frac{1}{2} \left(\frac{\ip{U}{U}}{R^2} + \frac{V^2}{R^2} +
  \ip{\chi}{\chi} + 2\pb{\chi}{U}\right) \left(n \lp \chi +
  \ip{n}{\chi} + \pb{n}{u} \right) 
   \\ & & \mbox{} 
  + \frac{1}{2} n \pb{\frac{\ip{U}{U}}{R^2}}{U}
  + \frac{1}{2} n \ip{\frac{\ip{U}{U}}{R^2}}{\chi}
  + n \pb{U}{\pb{U}{\chi}}
   \\ & & \mbox{} 
  + \frac{1}{2} n \pb{\frac{V^2}{R^2}}{U}
  + \frac{1}{2} n \ip{\frac{V^2}{R^2}}{\chi}
   \\ & & \mbox{} 
  + \frac{1}{2} n \ip{\ip{\chi}{\chi}}{\chi}
  + \frac{1}{2} n \pb{\ip{\chi}{\chi}}{U}
  + n \ip{\pb{\chi}{U}}{\chi}.
\end{eqnarray*}
Of course, in the case of no-slip or no-normal-flow boundary
conditions, 
\begin{equation}
  \frac{1}{2} \int dV\ \div \left(n u^2 \u\right) = 
  \frac{1}{2} \oint dS\ n u^2 \uvec{n} \cdot \u
  = 0.
\end{equation}


\subsection{Heat Flux}

The final term represents the heat flux:
\begin{eqnarray*}
  \div \q & = & -\kappa \lp{T} - \ip{\kappa}{T} 
  - \pb{\psi}{\kappa_\parallel \frac{\pb{\psi}{T}}{B^2}}
  + \pb{\kappa_\times F}{T}
\end{eqnarray*}
The total energy flux due to the divergence of the heat flux density
is
\begin{eqnarray*}
  \int dV\ \div \q & = & 
  \oint dS\ \uvec{n} \cdot \left(-\kappa \grad T 
   - \kappa_\parallel \frac{\B \B}{B^2} \cdot \grad T\right)
   \\
   & = & \oint dS\ \left(-\kappa \uvec{n} \cdot \grad T 
   - \frac{1}{R} \kappa_\parallel \uvec{t}\cdot \grad \psi 
   \frac{\B}{B^2} \cdot \grad T 
   + \frac{1}{R} \kappa_\times F \uvec{t} \cdot \grad T \right),
\end{eqnarray*}
the isotropic diffusion part of which vanishes in the case of
no-normal-tem\-per\-a\-ture-grad\-i\-ent boundary conditions.


\chapter{Boundary Conditions}

In all cases, $f = 0$ on the boundary, and therefore also $\uvec{t}
\cdot \grad{f} = 0$.  Some other boundary conditions that may be
specified are as follows:

\begin{description}
\item[No normal flow (\texttt{inonormalflow=1})] Holds $\uvec{n} \cdot
  \u$ constant.
\item[No poloidal flow (\texttt{inoslip\_pol=1})] Holds $\uvec{t} \cdot
  \u$ constant.
\item[No toroidal flow (\texttt{inoslip\_tor=1})] Holds $\uvec{\tor}
  \cdot \u$ constant.
\item[No normal current (\texttt{inocurrent\_norm=1})] Holds $\uvec{n} \cdot
  \j$ constant.
\item[No poloidal current (\texttt{inocurrent\_pol=1})] Holds $\uvec{t} \cdot
  \j$ constant.
\item[No toroidal current (\texttt{inocurrent\_tor=1})] Holds $\uvec{\tor}
  \cdot \j$ constant.
\end{description}

\begin{eqnarray}
  \uvec{n} \cdot \u & = & 
  -R \uvec{t}\cdot\grad{U}+ \frac{1}{R^2} \uvec{n} \cdot \grad{\chi}
  \\
  \uvec{t} \cdot \u & = & 
  R \uvec{n}\cdot\grad{U} + \frac{1}{R^2} \uvec{t} \cdot \grad{\chi}
  \\
  \uvec{\tor} \cdot \u & = & R \omega
\end{eqnarray}

\begin{eqnarray}
  \uvec{n} \cdot \B & = & 
  -\frac{1}{R} \uvec{t}\cdot\grad{\psi}
  - \frac{1}{R^2} \uvec{n} \cdot \grad{f_\tor}
  \\
  \uvec{t} \cdot \B & = & 
  \frac{1}{R} \uvec{n}\cdot\grad{\psi} 
  \\
  \uvec{\tor} \cdot \B & = & \frac{F}{R}
\end{eqnarray}

\begin{eqnarray}
  \uvec{n} \cdot \j & = & 
  -\frac{1}{R} \uvec{t} \cdot \grad{F}
  + \frac{1}{R^2} \uvec{n} \cdot \grad{\psi_\tor}
  \\
  \uvec{t} \cdot \j & = & 
  \frac{1}{R} \uvec{n}\cdot\grad{(F + f_{\tor \tor})} 
  + \frac{1}{R^2} \uvec{t} \cdot \grad{\psi_\tor}
  \\
  \uvec{\tor} \cdot \j & = & -\frac{1}{R}\gs{\psi}
\end{eqnarray}
In the above definitions, $\uvec{n}$ is the unit vector normal to the
boundary surface, and $\uvec{t} = \uvec{\tor} \times \uvec{n}$.

\section{Resistive Wall Boundary Condition}

For a thin resistive wall of resistivity $\eta_W$ and width
$\delta_W$, the following equations are obtained at the
boundary~\cite{Jardin10}:
\begin{eqnarray}
  \ddt{\psi} & = & -\frac{\eta_W}{\delta_W} \left(\uvec{n} \cdot
  \grad{\psi} - R \uvec{t} \cdot \B_v \right)
    \\
  \ddt{F} & = & -\frac{\eta_W}{\delta_W} \left(F - R \uvec{\tor} \cdot
  \B_v \right)
\end{eqnarray}
Here, $\B_v$ is the magnetic field on the outside of the wall.  $B_v$
may be obtained from the magnetic field on the inside of the wall
using a vacuum response matrix calculated by the $\textsc{vacuum}$
code,~\cite{Chance10} for example.

\subsection{Using a resistive wall in \codename\ with \textsc{vacuum}}

The following assumes that the \textsc{vacuum} code is located in the
directory \texttt{\$VACUUM\_DIR}.  On \texttt{sunfire},
\texttt{\$VACUUM\_DIR = /u/chance/Vacuum\_SVN\_Work}

\begin{enumerate}
\item Build \textsc{struct2vac} with\\
  \texttt{make OPT=1 struct2vac}
\item Generate \texttt{ordered.points} by running \textsc{struct2vac}
  in the working directory.
\item \texttt{tac ordered.points > vacin\_c1}
\item Edit \texttt{vacin\_c1}, and move the last line to be the first
  line.
\item \texttt{cp vacin\_c1 ordered.points}
\item \texttt{cp \$VACUUM\_DIR/Runs/C1Vac/modiv\_m3dc1 .}
\item \texttt{\$VACUUM\_DIR/Bin/vacuum.x86\_64.linux vacin\_c1 modiv\_m3dc1}
\item In \texttt{C1input}, set \texttt{eta\_wall} and
  \texttt{delta\_wall} to the appropriate values.
\end{enumerate}

Presently, the resistive wall only works on single-process runs.



\chapter{Discretization}

\section{Finite Elements}

Each field is represented as a linear combination of $N$ basis
functions $\nu_i$ on the computational domain
\[ U = \sum_{i=1}^N \nu_i U_i. \]
The finite element used in \codename is the reduced quintic element
\cite{Jardin04}, in which the basis functions are fifth order
polynomials.  At each time step, the projection of the equations onto
the basis functions are computed and solved.  For example, the
equation
\[ \ddt{U} = F(U) \]
becomes the system of projection equations
\[ \int dV\, \nu_i \ddt{U} = \int dV\, \nu_i F(U). \]
These projections equations are known collectively as the \emph{weak
form} of the equation.  Solving the equation in this manner is known
as the \emph{Galerkin method}.  Hereafter the index $i$ will be
dropped from $\nu_i$.

Once the equations are cast in the weak form, integrations by parts
may be carried out in order to reduce the order of the differential
operators acting on the physical fields.  For example, 
\begin{eqnarray*}
  \int dV\, \nu \nabla^2 U 
  & = & \int dV\, \div{(\nu \grad{U})} - \grad{\nu} \cdot \grad{U}\\
  & = & \oint d\vec{A} \cdot \grad{U} \nu - \int dV\, \ip{\nu}{\nabla U}\\
  & = & - \int dV\, \ip{\nu}{U}.
\end{eqnarray*}
It is found that using integrations by parts to re-cast the equations
into a form in which a roughly equal number of derivatives acts on the
trial function as on the physical fields improves the numerical
stability of methods for solving the equations.  Thus, in the above
example, the form $-\ip{\nu}{U}$ is preferable to $\nu \nabla^2
U$.

\subsection{Weak form of Physical Equations}

\subsubsection{Integration Identities}

Rather than performing integrations by parts directly on each term in
equations~(\ref{eq:scalar_equations}), it is simpler to begin directly
from the vector form, equations~(\ref{eq:xmhd}) and use the following
identities when applying the operations to extract the scalar
equations:
\begin{eqnarray*}
  -\int dV\, R^2 \nu \grad{\tor} \cdot \curl{\vec{A}} & = & 
  -\int dV\, \vec{A} \cdot \left[\grad{(R^2 \nu)} \times \grad{\tor}
    \right]
  \\
  \int dV\, \nu \div{\vec{A}} & = & 
  -\int dV\, \grad{\nu} \cdot \vec{A}.
\end{eqnarray*}
(Note that the torodal operator, $R^2 \nu \grad{\tor} \cdot$, is not a
differential operator and therefore the integration by parts cannot be
performed \emph{a priori}.)  

Similary, useful identities for the operators that will act on the
stress tensor $\P$ are:
\begin{subequations}
\label{eq:tensor_identities}
\begin{eqnarray}
  R^2 \nu \grad{\tor} \cdot \curl{(\div{\P})} & = & 
  R^2 \partial_Z \nu \grad{\tor} \cdot \P \cdot \grad{\tor}
  - \grad{\nu} \cdot \P \cdot \grad{Z}
  \\ && \mbox{}
  + r \grad{\tor} \cdot \left[\grad{\grad{(\nu r)}} \dottimes \P\right]
  + \div{ \vec{A}_1 }\nonumber
  \\
  -R^2 \nu \grad{\tor} \cdot (\div{\P}) & = &
  R^2 \grad{\nu} \cdot \P \cdot \grad{\tor}
  + \div{\vec{A}_2}
  \\
  -\nu \div{(\div{\P})} & = & -\grad{\grad{\nu}} \dotdot \P + \div{\vec{A}_3}
\end{eqnarray}
\end{subequations}
where
\begin{eqnarray*} 
  \vec{A}_1 & = & 
  - R^2 \nu \grad{\tor} \times (\div{\P})
  - r \P \cdot \left[ \grad{\tor} \times \grad{(r \nu)} \right]
  + \nu \P \cdot \grad{Z}
  \\
  \vec{A}_2 & = & -R^2 \nu \P \cdot \grad{\tor}
  \\
  \vec{A}_3 & = & \grad{\nu} \cdot \P - \nu \div{\P}.
\end{eqnarray*}
(These identities hold for any symmetric tensor $\P$.)  The total
divergences vanish upon integration.

\subsection{Physical Equations after Integrations by Parts}

\begin{subequations}
  \label{eq:equations_ibp}
\begin{eqnarray}
  \int dV\, N_n & = & \int dV\, \left[
    N_{n U} + N_{n \chi} + N_{n D} \right]
  \\
  \int dV\, \left[U_{U n} + U_{\chi n}\right] & = & \int dV\, 
  \left[ 
    U_{U U n} + U_{V V n} + U_{U \chi n} + U_{\chi \chi n} 
    \right. \\ && \nonumber \left. \mbox{} 
    + U_{\psi \psi} + U_{F F} + U_{U \mu} + U_{\chi \mu} + U_g
    \right. \\ && \nonumber \left. \mbox{} 
    + U_{U D} + U_{\chi D} + U_{\P_\parallel} + U_{\P_\times}
    \right]
  \\
  \int dV\, V_{V n} & = & \int dV\, \left[
    V_{V U n} + V_{V \chi n} + V_{\psi F} + V_{V \mu} 
    \right. \\ && \nonumber \left. \mbox{} + V_{V D}  
    + V_{\P_\parallel} + V_{\P_\times} \right]
  \\
  \int dV\, \left[X_{U n} + X_{\chi n}\right] & = & \int dV\, \left[
    X_{U U n}+ X_{V V n}+ X_{U \chi n}+ X_{\chi \chi n} 
    \right.\\  && \nonumber \left. \mbox{} 
    + X_p + X_{\psi \psi} + X_{F F} + X_{U \mu} + X_{\chi \mu} + X_g 
    \right. \\ && \nonumber \left. \mbox{} 
    + X_{U D} + X_{\chi D} + X_{\P_\parallel} + X_{\P_\times}
    \right]
  \\
  \int dV\, \Psi_\psi & = & \int dV\, \left[
    \Psi_{\psi U} + \Psi_{\psi \chi} + \Psi_{\psi F n}
    + \Psi_{\psi \eta} \right]
  \\
  \int dV\, F_F & = & \int dV\, \left[
    F_{F U} + F_{\psi V} + F_{F \chi} + F_{\psi n} + F_{F n} 
    \right. \\ && \nonumber \left. \mbox{} + F_{p_e n} + F_{F \eta} \right]
  \\
  \int dV\, P_p & = & \int dV\, \left[
    P_{p U} + P_{p \chi} + P_{p_e F n} + P_{\eta \psi} + P_{\eta F} 
    \right. \\ && \nonumber \left. \mbox{} 
    + P_\kappa + P_{\kappa_\parallel} + P_{\kappa_\times} \right]
\end{eqnarray}
\end{subequations}

The terms in the above equations are categorized and defined in the
following sections.  Each term has been integrated by parts to arrive
at the simplest expression having for which the order of
differentiation on the trial function is roughly equal to that on the
physical fields.

\subsubsection{Basic Terms}

The terms in this section are the basic terms in the two-fluid
equations, which do not depend on any specific choice of closure.

\begin{equation}
  \begin{array}{ll}
  N_n(\nu, \dot{n}) & = \nu \dot{n}\\
  N_{n U}(\nu, n, U) & = \nu \pb{U}{n}\\
  N_{n \chi}(\nu, n, \chi) & = n \ip{\nu}{\chi}\\
  N_{n D}(\nu, n, D) & = - D \ip{\nu}{n}
  \end{array}
\end{equation}

\begin{equation}
  \begin{array}{lcl}
    U_{U n}(\nu, \dot U, n) & = & -\frac{1}{R^2} n \ip{R^2 \nu}{\dot{U}}
    \\
    U_{\chi n}(\nu, \dot \chi, n) & = & -R^2 \nu \pb{n}{\dot{\chi}}
    \\
    U_{U U n}(\nu, U, U, n) & = & \frac{1}{R^2} n \gs{U} \pb{R^2\nu}{U}
      + \frac{1}{2 R^2} \ip{U}{U}\pb{R^2\nu}{n}
    \\
    U_{V V n}(\nu, V,  V, n) & = &  \frac{1}{2 R^2} \pb{\nu}{R^2} V V n
    \\
    U_{U \chi n}(\nu, U, \chi, n) & = & 
      \frac{1}{R^2}n \gs{U}\ip{R^2\nu}{\chi} 
      - \pb{U}{\chi} \pb{R^2\nu}{n}
    \\
    U_{\chi \chi n}(\nu, \chi, \chi, n) & = &
      \frac{1}{2} \ip{\chi}{\chi} \pb{R^2 \nu}{n}
    \\
    U_{\psi \psi}(\nu, \psi, \psi) & = &
      -\frac{1}{R^2} \pb{R^2 \nu}{\psi} \gs{\psi}
    \\
    U_{F F}(\nu, F, F) & = & -R^2 \nu F \pb{F}{\frac{1}{R^2}}
    \\
    U_{U D}(\nu, U, D) & = & \frac{1}{R^2} \ip{R^2 \nu}{U} D
    \\
    U_{\chi D}(\nu, \chi, D) & = & -\pb{R^2 \nu}{\chi} D
  \end{array}
\end{equation}

\begin{equation}
  \begin{array}{lcl}
    V_{V n}(\nu, V, n) & = & \nu n \dot{V}\\
    V_{V U n}(\nu, V, U, n) & = & \nu n \pb{U}{V}\\
    V_{V \chi n}(\nu, V, \chi, n) & = & -\nu n \ip{\chi}{V}\\
    V_{\psi F}(\nu, \psi, F) & = & \nu \pb{F}{\psi}\\
    V_{V D}(\nu, V, D) & = & -\nu V D
  \end{array}
\end{equation}    

\begin{equation}
  \begin{array}{lcl}
    X_{U n}(\nu, \dot U, n) & = & \nu \pb{n}{\dot{U}}
    \\
    X_{\chi n}(\nu, \dot \chi, n) & = & -n \ip{\nu}{\dot{\chi}}
    \\
    X_p(\nu, p) & = & \ip{\nu}{p}
    \\
    X_{U U n}(\nu, U, U, n) & = & -\frac{1}{R^2} n \gs{U} \ip{\nu}{U}
      + \frac{1}{2} n \ip{\nu}{\frac{\ip{U}{U}}{R^2}}
    \\
    X_{V V n}(\nu, V,  V, n) & = & 
      \frac{1}{2} n V V \ip{\frac{1}{R^2}}{\nu}
    \\
    X_{U \chi n}(\nu, U, \chi, n) & = & 
      \left( n \lp{\nu} + \ip{n}{\nu} \right) \pb{U}{\chi}
      + n \gs{U} \pb{\nu}{\chi}
    \\
    X_{\chi \chi n}(\nu, \chi, \chi, n) & = & \frac{1}{2} n 
      \ip{\nu}{\ip{\chi}{\chi}}
    \\
    X_{\psi \psi}(\nu, \psi, \psi) & = & 
      \frac{1}{R^2} \gs{\psi} \ip{\nu}{\psi}
    \\
    X_{F F}(\nu, F, F) & = & \frac{1}{R^2} F \ip{\nu}{F}
    \\
    X_{U D}(\nu, U, D) & = & \pb{\nu}{U} D
    \\
    X_{\chi D}(\nu, \chi, D) & = & \ip{\nu}{\chi} D
  \end{array}
\end{equation}


\begin{equation}
  \begin{array}{lcl}
    \Psi_{\psi}(\nu, \dot{\psi}) & = & \nu \dot{\psi}\\
    \Psi_{\psi U}(\nu, \psi, U) & = & \nu \pb{U}{\psi}\\
    \Psi_{\psi \chi}(\nu, \psi, \chi) & = & -\nu \ip{\chi}{\psi}\\
    \Psi_{\psi F n}(\nu, \psi, F, n) & = & d_i \nu \frac{1}{n} \pb{\psi}{F}\\
    \Psi_{\psi \eta}(\nu, \psi, \eta) & = & 
        -\frac{1}{R^2} \ip{\psi}{R^2 \nu \eta} 
  \end{array}
\end{equation}

\begin{equation}
  \begin{array}{lcl}
    F_F (\nu, \dot{F}) & = & \nu \dot{F}\\
    F_{F U}(\nu, F, U) & = & R^2 \nu \pb{U}{\frac{F}{R^2}}\\
    F_{\psi V}(\nu, \psi, V) & = & R^2 \nu \pb{\frac{V}{R^2}}{\psi}\\
    F_{F \chi}(\nu, F, \chi) & = & \frac{F}{R^2} \ip{R^2 \nu}{\chi}\\
    F_{\psi n}(\nu, \psi, \psi, n) & = &
       d_i \frac{\gs{\psi}}{R^2 n}\pb{\psi}{R^2\nu}\\
    F_{F n}(\nu, F, F, n) & = &
       d_i R^2 \nu F \pb{\frac{1}{R^2 n}}{F}\\
    F_{p_e n}(\nu, p_e, n) & = & d_i R^2 \nu \pb{\frac{1}{n}}{p_e}\\
    F_{F \eta}(\nu, F, \eta) & = & -\frac{1}{R^2} \eta \ip{R^2 \nu}{F}
  \end{array}
\end{equation}

\begin{equation}
  \begin{array}{lcl}
  P_p(\nu, \dot{p}) & = & \nu \dot{p}
  \\
  P_{p U}(\nu, p, U) & = & \nu \pb{U}{p}
  \\
  P_{p \chi}(\nu, p, \chi) & = & \Gamma p \ip{\nu}{\chi} 
    + (\Gamma - 1) \nu \ip{p}{\chi}
  \\
  P_{p_e, F, n}(\nu, p_e, F, n) & = & d_i \left( 
      \frac{1}{n} \nu \pb{p_e}{F} 
    + \Gamma \nu p_e \pb{\frac{1}{n}}{F} \right)
  \\
  P_{\eta, \psi}(\nu, \eta, \psi, \psi) & = & (\Gamma - 1) \nu
  \frac{(\gs{\psi})^2}{R^2}
  \\
  P_{\eta, F}(\nu, \eta, F, F) & = & (\Gamma - 1) \nu \frac{F^2}{R^2}
  \end{array}
\end{equation}

\subsubsection{Gravity}

These terms are obtained assuming a gravitational force of the form given by
equation~(\ref{eq:gravity}).

\begin{equation}
  \begin{array}{lcl}
    U_g(\nu, n) & = & g_r \nu \pb{n}{R} - g_Z r \nu \ip{n}{R}
    \\
    X_g(\nu, n) & = & \frac{n}{R^2} \left( 
    g_r \ip{\nu}{R} + g_Z r \pb{\nu}{R} \right)
  \end{array}
\end{equation}



\subsubsection{Heat Flux Terms}

These terms are obtained assuming a heat flux density of the form
described in section~\ref{sec:heat_flux}.

\begin{equation}
  \begin{array}{lcl}
    P_\kappa(\nu, \kappa, T) & = &
    -(\Gamma - 1) \kappa \ip{\nu}{T}
    \\
    P_{\kappa_\parallel}(\nu, \kappa_\parallel, T, \psi, \psi, B^{-2}) & = &
    -(\Gamma - 1) \kappa_\parallel \frac{1}{B^2} \pb{\psi}{\nu} \pb{\psi}{T}
    \\
    P_{\kappa_\times}(\nu, \kappa_\times, T, F, B^{-2}) & = & 
    (\Gamma - 1) \kappa_\times \frac{F}{B} \pb{\nu}{T}
  \end{array}
\end{equation}

\begin{eqnarray*}
  T & = & p/n \\
  B^2 & = & \frac{1}{R^2} \left[ \ip{\psi}{\psi} + F^2 \right]
\end{eqnarray*}


\subsubsection{Isotropic Viscosity}

These terms result from isotropic viscosity of the form given by
equation~(\ref{eq:general_viscosity}).

\begin{equation}
  \begin{array}{lcl}
    U_{U \mu}(\nu, U, \mu) & = & \frac{1}{R^2} \left [ \left(
      \ip{\mu}{R^2 \nu} + \mu \gs{(R^2 \nu)} \right) \gs{U} \right. \\
      & & \left. \mbox{} + \lp{\mu} \ip{R^2 \nu}{U} 
      + \gs{(R^2 \nu)} \ip{\mu}{U} \right]
    \\
    U_{\chi \mu}(\nu, \chi, \mu) & = & -\lp{(R^2 \nu)} \pb{\mu}{\chi}
      - \gs{\mu}\pb{R^2\nu}{\chi} \\ & & \mbox{}
      - \frac{1}{R^2}\gs{(R^2 \chi)} \pb{R^2 \nu}{\mu}
    \\
    V_{V \mu}(\nu, V, \mu) & = & \left[\ip{\nu}{\mu} 
      + \frac{1}{R^2}\mu \gs{(R^2 \nu)} \right] V
    \\
    X_{U \mu}(\nu, U, \mu) & = & \lp{\nu} \pb{\mu}{U} 
      + \lp{\mu} \pb{\nu}{U} + \gs{U} \pb{\nu}{\mu}
    \\
    X_{\chi \mu}(\nu, \chi, \mu, \mu_c) & = & 
      \lp{\nu} \ip{\mu}{\chi} + \lp{\mu} \ip{\nu}{\chi}
      + 2 \mu_c \lp{\nu} \lp{\chi}
  \end{array}
\end{equation}

\subsubsection{Parallel Viscosity}

These terms are obtained assuming a parallel viscosity of the form
given in equation~(\ref{eq:parallel_viscosity}).  These equations were
obtained using equations~(\ref{eq:tensor_identities}).  For
compactness, derivatives are written as subscripts in the following
expressions (\textit{i.e.} $\nu_Z = \partial_Z \nu$).

\begin{equation}
  \begin{array}{lcl}
    U_{\P_\parallel U}(\nu, U) & = & {\mu_\parallel}_U D_U
    \\
    U_{\P_\parallel V}(\nu, V) & = & {\mu_\parallel}_V D_U
    \\
    U_{\P_\parallel \chi}(\nu, \chi) & = & {\mu_\parallel}_\chi D_U
  \end{array}
\end{equation}

\begin{equation}
  \begin{array}{lcl}
    V_{\P_\parallel U}(\nu, U) & = & {\mu_\parallel}_U D_V
    \\
    V_{\P_\parallel V}(\nu, V) & = & {\mu_\parallel}_V D_V
    \\
    V_{\P_\parallel \chi}(\nu, \chi) & = & {\mu_\parallel}_\chi D_V
  \end{array}
\end{equation}

\begin{equation}
  \begin{array}{lcl}
    X_{\P_\parallel U}(\nu, U) & = & {\mu_\parallel}_U D_X
    \\
    X_{\P_\parallel V}(\nu, V) & = & {\mu_\parallel}_V D_X
    \\
    X_{\P_\parallel \chi}(\nu, \chi) & = & {\mu_\parallel}_\chi D_X
  \end{array}
\end{equation}

\begin{eqnarray*}
  D_U & = & \frac{3}{B^2} \left\{ 
  - \frac{1}{2}R^2\pb{\nu}{\frac{\ip{\psi}{\psi}}{R^2}}
  + \ip{\psi}{\pb{\nu}{\psi}} 
  - \frac{1}{R^2} F^2 \nu_Z 
  \right.\\ && \left. \mbox{}
  - \frac{2}{R^2}\left[ \nu_Z (\psi_Z^2 - \psi_R^2) + 2\nu_r \psi_r \psi_Z
    \right]
  \right\}
  \\
  D_V & = & - 3 \frac{F}{B^2} \pb{\nu}{\psi}
  \\
  D_X & = & - \lp{\nu} 
  \left(1 - \frac{3}{R^2}\frac{\ip{\psi}{\psi}}{B^2} \right)
  \\ &&  \mbox{}
  + \frac{3}{R^2 B^2} \left(
    \frac{1}{2}R^2\ip{\nu}{\frac{\ip{\psi}{\psi}}{R^2}}
    - \ip{\psi}{\ip{\nu}{\psi}} 
    + \frac{1}{R} F^2 \nu_r \right)
\end{eqnarray*}

\begin{eqnarray*}
  {\mu_\parallel}_U & = & \eta_0 \frac{p_i \tau_i}{R^2 B^2} \left( 
  - \frac{1}{2} R^2 \pb{U}{\frac{\ip{\psi}{\psi}}{R^2}}
  + \ip{\psi}{\pb{U}{\psi}}
  - \frac{1}{R^2} F^2 U_Z \right)
  \\
  {\mu_\parallel}_V & = & -\eta_0 p_i \tau_i \frac{F}{B^2} 
  \pb{\psi}{\frac{V}{R^2}}
  \\
  {\mu_\parallel}_\chi & = & \eta_0 \frac{p_i \tau_i}{R^2 B^2} \left(
    \frac{1}{2} R^2 \ip{\chi}{\frac{\ip{\psi}{\psi}}{R^2}}
  - \ip{\psi}{\ip{\chi}{\psi}}
  + \frac{1}{R} F^2 \chi_r 
  \right.\\ && \left. \mbox{}
  + \lp{\chi} \ip{\psi}{\psi}
  \right)
\end{eqnarray*}


\subsubsection{Gyroviscosity}

These terms are obtained using equations~(\ref{eq:tensor_identities})
assuming a gyroviscosity of the form given by
equation~(\ref{eq:gyroviscosity}).

\begin{eqnarray*}
  & \lefteqn{U_{\P_\times U}(\nu, U) = -\frac{p_i F}{2 R^3 B^2}} & 
  \\ & & \mbox{} \times
    \left\{ \begin{array}{l} 
      \left(1+\frac{3}{2 R^2}\frac{\ip{\psi}{\psi}}{B^2}\right)
      \left[ \begin{array}{r@{}l}
	     & \left( [R^3 \nu_Z]_Z - [R^3 \nu_r]_r \right)
	       \left( \left[\frac{U_R}{R}\right]_Z 
	            + \left[\frac{U_Z}{R}\right]_r \right) 
             \\ \mbox{}
	   - & \left( [R^3 \nu_r]_Z + [R^3 \nu_Z]_r \right)
	       \left( \left[\frac{U_Z}{R}\right]_Z 
	            - \left[\frac{U_R}{R}\right]_r \right) 
	     \end{array} \right]
       \\ \mbox{}
      + \frac{9}{2 r B^2} 
      \\ \mbox{} \times \left[ 
	\begin{array}{r@{}l}
	  \left( \psi_Z^2 - \psi_R^2 \right) &
	  \left( r \nu_Z \left[ 
	    \left( \frac{U_Z}{R} \right)_Z -
	    \left( \frac{U_R}{R} \right)_r \right]
          -\frac{1}{R^3} U_Z \left[ 
	    (R^3 \nu_Z)_Z - (R^3 \nu_r)_r \right] \right)
	  \\ 
	  \mbox{} + 2 \psi_r \psi_Z &
          \left( r \nu_Z \left[ 
	    \left( \frac{U_R}{R} \right)_Z +
	    \left( \frac{U_Z}{R} \right)_r \right]
          -\frac{1}{R^3} U_Z \left[ 
	    (R^3 \nu_r)_Z + (R^3 \nu_Z)_r \right] \right)
	  \end{array} \right] 
    \end{array} \right\}
\end{eqnarray*}

\begin{eqnarray*}
  & \lefteqn{U_{\P_\times V}(\nu, V) = -\frac{p_i}{B^2}} &
  \\ && \mbox{} \times
  \left\{ \begin{array}{l}
      \frac{1}{4 R^2} \left(1 - \frac{3 F^2}{B^2 R^2} \right) 
      \\ \mbox{} \times
      \left( \ip{\frac{V}{R^2}}{R^4 \pb{\psi}{\nu}}
            -\ip{\psi}{R^4\pb{\nu}{\frac{V}{R^2}}}
	    +\frac{1}{R^2}\pb{\nu}{R^6\ip{\frac{V}{R^2}}{\psi}} \right)
      \\ \mbox{}
      -\frac{3}{4 B^2} \pb{\psi}{\frac{V}{R^2}}
      \\ \mbox{} \times
      \left( 2 \ip{\psi}{\ip{\psi}{\nu}}
           - R^2 \ip{\nu}{\frac{\ip{\psi}{\psi}}{R^2}}
	   - \gs{\nu} \ip{\psi}{\psi}
	   + 6 \psi_Z \pb{\nu}{\psi} \right)
      \\ \mbox{}
      +\frac{9 F^2}{2 B^2 R^2} \nu_Z \ip{\psi}{\frac{V}{R^2}}
    \end{array} \right\}
\end{eqnarray*}

\begin{eqnarray*}
  & \lefteqn{U_{\P_\times \chi}(\nu, \chi) = -\frac{p_i F}{2 R^3 B^2}} &
  \\ && \mbox{} \times 
  \left\{ \begin{array}{l}
    \left[ \left( \chi_{R R} - \chi_{Z Z} \right)
           \left( [R^3 \nu_r]_r - [R^3 \nu_Z]_Z \right)
       +   2 \chi_{R Z} 
           \left( [R^3 \nu_r]_Z + [R^3 \nu_Z]_r \right)
           \right]
    \\ \mbox{}
    + \frac{3}{R^2 B^2} \left[ \begin{array}{l} 
	\left( \gs{\chi}[\psi_Z^2 - \psi_R^2] 
        - \chi_{Z Z} \psi_Z^2 + \chi_{R R} \psi_R^2 \right)
	\left( [R^3 \nu_r]_r - [R^3 \nu_Z]_Z \right)
	\\ \mbox{} + 2 \chi_{R Z} 
	\left( \psi_Z^2 [R^3 \nu_r]_Z
	      +\psi_R^2 [R^3 \nu_Z]_r \right)
	\\ \mbox{} - 2 \psi_r \psi_Z 
	\left( \left[\chi_{Z Z} - \frac{1}{R}\chi_r \right] [R^3 \nu_r]_Z
	      +\left[\chi_{R R} - \frac{1}{R}\chi_r \right][R^3 \nu_Z]_r 
	      \right)
      \end{array} \right]
  \end{array} \right\}
\end{eqnarray*}

\begin{eqnarray*}
  & \lefteqn{V_{\P_\times U}(\nu, U) = \frac{p_i}{4 r B^2}} &
  \\ && \mbox{} \times 
  \left\{ \begin{array}{l}
    \left(1 - \frac{3}{R^2} \frac{F^2}{B^2} \right)
    \left( \ip{\psi}{R \pb{U}{\nu}}+\ip{\nu}{R \pb{U}{\psi}}
          -\frac{1}{R^3} \pb{U}{R^4 \ip{\nu}{\psi}}
	  +U_r \pb{\nu}{\psi} + \frac{2}{R} \psi_Z \ip{\nu}{U} \right)
    \\ \mbox{} + 
    \frac{3}{R B^2} \pb{\psi}{\nu}
    \left( 2\ip{\psi}{\ip{U}{\psi}} - \gs{U}\ip{\psi}{\psi} 
          - \frac{1}{R^2}\ip{U}{R^2\ip{\psi}{\psi}} 
	  +\pb{\psi}{R^2}\pb{\psi}{U} \right)
    \\ \mbox{} - 
    \frac{18}{R^2} \frac{F^2}{B^2} \pb{U}{R} \ip{\nu}{\psi}
  \end{array} \right\}
\end{eqnarray*}

\begin{eqnarray*}
  V_{\P_\times V}(\nu, V) & = & \frac{p_i F R^2}{4 B^2}
  \left(1 - \frac{3}{R^2} \frac{\ip{\psi}{\psi} - F^2}{B^2} \right)
    \pb{\nu}{\frac{V}{R^2}}
\end{eqnarray*}

\begin{eqnarray*}
  & \lefteqn{V_{\P_\times \chi}(\nu, \chi) = \frac{p_i}{B^2}} &
  \\ && \mbox{} \times 
  \left\{ \begin{array}{l}
    \left( \frac{1}{R^2}\ip{\chi}{R^2 \ip{\nu}{\psi}}
          -\ip{\nu}{\ip{\chi}{\psi}} - \ip{\psi}{\ip{\nu}{\chi}} \right)
    \\ \mbox{} + \frac{3}{2 r B^2} \pb{\psi}{\nu}
    \left( \ip{\psi}{R \pb{\chi}{\psi}} 
         - \frac{1}{2} r \pb{\chi}{\ip{\psi}{\psi}} \right)
    \\ \mbox{} + \frac{3}{4 R^2} \frac{F^2}{B^2}
    \left( \ip{\psi}{\ip{\chi}{\nu}} + \ip{\nu}{\ip{\chi}{\psi}}
          -\ip{\chi}{\ip{\nu}{\psi}} - 2 \gs{\chi}\ip{\nu}{\psi} \right)
  \end{array} \right\}
\end{eqnarray*}

\begin{eqnarray*}
  & \lefteqn{X_{\P_\times U}(\nu, U) = \frac{p_i F}{2 R^2 B^2}} &
  \\ && \mbox{} \times  
  \left\{ \begin{array}{l}
  \funcss{\nu}{U} - R^2 \funcaa{\nu}{U} 
  + \frac{1}{R} \left[ U_r (\nu_{Z Z} - \nu_{R R})
                     -2 U_Z \nu_{R Z} - \frac{1}{R} U_r \nu_r \right]
  \\ \mbox{}
  + \frac{3}{R B^2} \left[ \begin{array}{l}
    \left( \left[\frac{U_Z}{R} \right]_Z 
         - \left[\frac{U_R}{R} \right]_r \right)
    \left(\nu_{Z Z} \psi_R^2 - \nu_{R R} \psi_Z^2
         +\frac{1}{R} \nu_r [\psi_Z^2 - \psi_R^2] \right)
    \\ \mbox{}
    + 2\nu_{R Z} \left( 
        \left[ \frac{U_R}{R} \right]_Z \psi_R^2
      + \left[ \frac{U_Z}{R} \right]_r \psi_Z^2
      - \frac{1}{R^2} U_Z [\psi_Z^2 - \psi_R^2] \right)
    \\ \mbox{}
    - 2 \psi_r \psi_Z \left( \begin{array}{l}
        \left[ \frac{U_R}{R} \right]_Z \nu_{R R}
      + \left[ \frac{U_Z}{R} \right]_r \nu_{Z Z}
      - \frac{1}{R^2} U_Z [\nu_{Z Z} - \nu_{R R}] 
      \\ \mbox{}
      - \frac{1}{R} \nu_r \left[ 
	  \left( \frac{U_R}{R} \right)_Z
	+ \left( \frac{U_Z}{R} \right)_r \right] 
      \end{array} \right)
    \end{array} \right]
  \end{array} \right\}
\end{eqnarray*}

\begin{eqnarray*}
  & \lefteqn{X_{\P_\times V}(\nu, V) = \frac{p_i}{4 B^2}} &
  \\ && \mbox{} \times 
  \left\{ \begin{array}{l}
    \left(1 - \frac{3}{R^2} \frac{F^2}{B^2} \right) \left(
    \frac{1}{R^2} \ip{\nu}{R^2\ip{\frac{V}{R^2}}{\psi}}
    - \ip{\psi}{\ip{\frac{V}{R^2}}{\nu}}
    - \ip{\frac{V}{R^2}}{\ip{\psi}{\nu}} \right)
    \\ \mbox{} + \frac{6}{B^2} \pb{\psi}{\frac{V}{R^2}}
    \left(\frac{1}{R} \ip{\psi}{R \pb{\nu}{\psi}}
    - \frac{1}{2} \pb{\nu}{\ip{\psi}{\psi}} \right)
    \\ \mbox{} - 6 \frac{F^2}{B^2} \ip{\psi}{\frac{V}{R^2}}
    \left[ \left(\frac{\nu_Z}{R^2} \right)_Z
         + \left(\frac{\nu_R}{R^2} \right)_r \right]
  \end{array} \right\}
\end{eqnarray*}


\begin{eqnarray*}
  & \lefteqn{X_{\P_\times \chi}(\nu, \chi) = -\frac{p_i F}{B^2}} &
  \\ && \mbox{} \times 
  \left\{ \begin{array}{l}
    \left(1 + \frac{3}{2 R^2} \frac{\ip{\psi}{\psi}}{B^2} \right)
    \funcsa{\nu}{\chi}
    \\ \mbox{} + \frac{3}{2 B^2} \left[ \begin{array}{r@{}l}
      & \left(- \frac{1}{2} \pb{\chi}{\ip{\psi}{\psi}}
	      + \frac{1}{R} \ip{\psi}{R\pb{\chi}{\psi}} 
             \right)
	\left( \left[ \frac{\nu_R}{R^2} \right]_r
	     + \left[ \frac{\nu_Z}{R^2} \right]_Z \right)
    \\ \mbox{}
     - & \left(- \frac{1}{2} \pb{\nu}{\ip{\psi}{\psi}}
               + \frac{1}{R} \ip{\psi}{R\pb{\nu}{\psi}} 
              \right)
         \left( \left[ \frac{\chi_R}{R^2} \right]_r
	      + \left[ \frac{\chi_Z}{R^2} \right]_Z \right)
      \end{array} \right]
  \end{array} \right\}
\end{eqnarray*}

\subsection{Spatial Integration}

The integrals required to calculate the weak-form equations of the
Galerkin method are computed numerically using a 79-point Gaussian
quadrature.  That is, the value of each field is calculated at 79
points for each triangular element, and a weighted sum of these values
is computed to approximate the integral.
\[
  \int dA\ f(x) \simeq \sum_{i=1}^{79} w_i f(x_i),
\]
where the integrand $f(x)$ is restricted to a single element.  The
sampling points and weights appropriate for a equilateral triangle are
taken from ref.~\cite{Dunavant85}.

The coordinates of the sampling points are given in the ``natural
coordinates'' $(\alpha, \beta, \gamma)$ in ref.~\cite{Dunavant85}.
These coordinates may be converted to cartesian coordinates $(r, Z)$
for an equilateral triangle $e$ having vertices
\[
\left\{\left(-\frac{\sqrt{3}}{2},-\frac{1}{2}\right),
\left(\frac{\sqrt{3}}{2},-\frac{1}{2}\right), (0,1)\right\} 
\]
using the linear transformation
\[ 
\phi_{n \to e}(\alpha, \beta, \gamma) = 
\left(\frac{\sqrt{3}}{2}(\beta-\gamma), \frac{1}{2}(3 \alpha - 1)
\right).
\]
The weights must be multiplied by the Jacobian of this transformation,
\[
\mathcal{J}_{\phi_{n \to e}} = \frac{3 \sqrt{3}}{4}.
\]
To find the coordinates of the sampling points for a general triangle
$g$ having vertices $\{(-b,0), (a,0), (0,c)\}$, as in
ref.~\cite{Jardin04}, one may use the linear transformation
\begin{eqnarray*}
  \phi_{e \to g}(r,Z) & = & 
    \left(\frac{a+b}{\sqrt{3}} x + \frac{a-b}{3} (1-y), 
    \frac{c}{3}(2y+1) \right) \\
  \mathcal{J}_{\phi_{e \to g}} & = &  \frac{2 c}{3 \sqrt{3}} (a+b).
\end{eqnarray*}
The transformation from natural coordinates to cartesian coordinates
for a triangle having vertices $\{(-b,0), (a,0), (0,c)\}$ is therefore
\begin{eqnarray*}
  \phi_{n \to g}(r,Z) & = & 
  \left(\frac{1}{2} (a+b) (\beta-\gamma) +
  \frac{1}{2} (a-b)(1-\alpha), c \alpha \right) \\
  \mathcal{J}_{\phi_{n \to g}} & = & \frac{1}{2} (a+b) c.
\end{eqnarray*}

The 79-point quadrature gives the exact results for integrands which
are polynomials of degree 20 (or less).  In the case of quintic finite
elements, this means the integration is exact for terms involving
products of three fields or fewer, not including the degree-five
trial function $\nu$.  In cylindrical geometry, the presence factors
of $1/R$ will cause the quadrature not to be exact, as $1/R$ is not in
the form of a polynomial.  The weights $w_i$ must also be multiplied
by $R_i$ in cylindrical coordinates to account for the Jacobian of the
transformation from cartesian to cylindrical coordinates.


\section{Time step}



\subsection{Implicit Time Advance}

For the implicit time advance, equations~(\ref{eq:equations_ibp}) are
evaulated at the $\theta$-advanced time (\emph{e.g.} $F(\psi) \to
F(\psi + \theta \dt \dot{\psi} + \cdots)$), linearized (\emph{i.e.}
$\order{\dt^2}$ and higher are dropped), and then discretized
temporally according to the chosen time integration method
(\emph{i.e.} $\dot{\psi} \to (\psi^{(n+1)} - \psi^{(n)})/\dt$).


\begin{eqnarray}
  \begin{pmatrix}
    \cola{S^v_{1 1}} & \cola{R^v_{1 1}} &
    \colb{S^v_{1 2}} & \colb{R^v_{1 2}} & 
          S^v_{1 3}  &        0         &
          R^v_{1 4}  &       R^v_{1 3}
    \\
    \cola{R^B_{1 1}} & \cola{S^B_{1 1}} &
    \colb{R^B_{1 2}} & \colb{S^B_{1 2}} & 
          R^B_{1 3}  &       S^B_{1 3}  &
              0      &        0
    \\
    \colb{S^v_{2 1}} & \colb{R^v_{2 1}} & 
    \colb{S^v_{2 2}} & \colb{R^v_{2 2}} & 
          S^v_{2 3}  &        0         &
	  R^v_{2 4}  &       R^v_{2 3}
    \\
    \colb{R^B_{2 1}} & \colb{S^B_{2 1}} &
    \colb{R^B_{2 2}} & \colb{S^B_{2 2}} & 
          R^B_{2 3}  &       S^B_{2 3}  &
              0      &        0
    \\
          S^v_{3 1}  &       R^v_{3 1}  &
          S^v_{3 2}  &       R^v_{3 2}  &
          S^v_{3 3}  &        0         &
	  R^v_{3 4}  &       R^v_{3 3}  
    \\
          R^B_{3 1}  &       S^v_{3 1}  &
          R^B_{3 2}  &       S^v_{3 2}  &
          R^B_{3 3}  &       S^v_{3 3}  &
              0      &        0
    \\
          R^n_{3 1}  &        0         &
          R^n_{3 2}  &        0         &
          R^n_{3 3}  &        0         &
          S^n        &        0
    \\
          R^p_{3 1}  &        0         &
          R^p_{3 2}  &        0         &
          R^p_{3 3}  &        0         &
              0      &       S^p        &
  \end{pmatrix}
  \begin{pmatrix}
    \cola{U}\\ \cola{\psi}\\ 
    \colb{V}\\ \colb{F}   \\
    \chi \\ p_e \\ 
    n \\ p
  \end{pmatrix}^{(n+1)} = \nonumber \\
  \begin{pmatrix}
    \cola{D^v_{1 1}} & \cola{Q^v_{1 1}} &
    \colb{D^v_{1 2}} & \colb{Q^v_{1 2}} & 
          D^v_{1 3}  &        0         &
          Q^v_{1 4}  &       Q^v_{1 3}
    \\
    \cola{Q^B_{1 1}} & \cola{D^B_{1 1}} &
    \colb{Q^B_{1 2}} & \colb{D^B_{1 2}} & 
          Q^B_{1 3}  &       D^B_{1 3}  &
              0      &        0
    \\
    \colb{D^v_{2 1}} & \colb{Q^v_{2 1}} & 
    \colb{D^v_{2 2}} & \colb{Q^v_{2 2}} & 
          D^v_{2 3}  &        0         &
	  Q^v_{2 4}  &       Q^v_{2 3}
    \\
    \colb{Q^B_{2 1}} & \colb{D^B_{2 1}} &
    \colb{Q^B_{2 2}} & \colb{D^B_{2 2}} & 
          Q^B_{2 3}  &       D^B_{2 3}  &
              0      &        0
    \\
          D^v_{3 1}  &       Q^v_{3 1}  &
          D^v_{3 2}  &       Q^v_{3 2}  &
          D^v_{3 3}  &        0         &
	  Q^v_{3 4}  &       Q^v_{3 3}  
    \\
          Q^B_{3 1}  &       D^v_{3 1}  &
          Q^B_{3 2}  &       D^v_{3 2}  &
          Q^B_{3 3}  &       D^v_{3 3}  &
              0      &        0
    \\
          Q^n_{3 1}  &        0         &
          Q^n_{3 2}  &        0         &
          Q^n_{3 3}  &        0         &
          D^n        &        0
    \\
          Q^p_{3 1}  &        0         &
          Q^p_{3 2}  &        0         &
          Q^p_{3 3}  &        0         &
              0      &       D^p        &
  \end{pmatrix}
  \begin{pmatrix}
    \cola{U}\\ \cola{\psi}\\ 
    \colb{V}\\ \colb{F}   \\
    \chi \\ p_e \\ 
    n \\ p
  \end{pmatrix}^{(n)} +   
  \begin{pmatrix}
    Q_1 \\ Q_2 \\ 
    Q_3 \\ Q_4 \\
    Q_5 \\ Q_6 \\ 
    Q_7 \\ Q_8
  \end{pmatrix}
\end{eqnarray}

\subsection{Split Time Step Method}



Time is advanced using a split time-step method in which the velocity
field is advanced first, then the density and total pressure fields
are advanced separately, and finally the magnetic field and electron
pressure are advanced together.  Though the velocity and magnetic
field are advanced separately, the Alfv\'en and magnetosonic waves are
treated implicitly by using
equations~(\ref{eq:scalar_p}--\ref{eq:scalar_F}) to calculate
analytically the advanced-time values of the pressure and magnetic
field for use in the velocity time step.



\begin{eqnarray}
  \label{eq:velocity_advance}
  \lefteqn{
  \begin{pmatrix}
    \cola{S^v_{1 1}} & \colb{S^v_{1 2}} & S^v_{1 3}\\
    \colb{S^v_{2 1}} & \colb{S^v_{2 2}} & S^v_{2 3}\\
          S^v_{3 1}  &       S^v_{3 2}  & S^v_{3 3}\\
  \end{pmatrix} 
  \begin{pmatrix}
    \cola{U}\\ \colb{V}\\ \chi
  \end{pmatrix}^{(n+1)}}\\
  & = & 
  \begin{pmatrix}
    \cola{D^v_{1 1}} & \colb{D^v_{1 2}} & D^v_{1 3}\\
    \colb{D^v_{2 1}} & \colb{D^v_{2 2}} & D^v_{2 3}\\
          D^v_{3 1}  &       D^v_{3 2}  & D^v_{3 3}\\
  \end{pmatrix} 
  \begin{pmatrix}
    \cola{U}\\ \colb{V}\\ \chi
  \end{pmatrix}^{(n)}
  + 
  \begin{pmatrix}
    \cola{Q^v_{1 1}} & \colb{Q^v_{1 2}} & Q^v_{1 3}\\
    \colb{Q^v_{2 1}} & \colb{Q^v_{2 2}} & Q^v_{2 3}\\
          Q^v_{3 1}  &       Q^v_{3 2}  & Q^v_{3 3}\\
  \end{pmatrix} 
  \begin{pmatrix}
    \cola{\psi}\\ \colb{F}\\ p
  \end{pmatrix}^{(n)} \nonumber
  \\ & & \mbox{} + 
  \begin{pmatrix}
    \cola{O^v_{1}}\\
    \colb{O^v_{2}}\\
          O^v_{3} \\
  \end{pmatrix} \nonumber
\end{eqnarray}

\begin{eqnarray}
  \label{eq:density_advance}
  S^n n^{(n+1)} & = & D^n n^{(n)} + 
  \begin{pmatrix} R^n_1 & R^n_2 & R^n_3\end{pmatrix}
  \begin{pmatrix}\cola{U}\\ \colb{V}\\ \chi\end{pmatrix}^{(n+1)}
  \\ & & \mbox{} + 
  \begin{pmatrix}Q^n_1    &   Q^n_2   & Q^n_3\end{pmatrix}
  \begin{pmatrix}\cola{U}\\ \colb{V}\\ \chi\end{pmatrix}^{(n)} \nonumber
\end{eqnarray}


\begin{eqnarray}
  \label{eq:pressure_advance}
  S^p p^{(n+1)} & = & D^p p^{(n)} + 
  \begin{pmatrix}R^p_1 & R^p_2 & R^p_3\end{pmatrix}
  \begin{pmatrix}\cola{U}\\ \colb{V}\\ \chi \end{pmatrix}^{(n+1)}
  \\ & & \mbox{} + 
  \begin{pmatrix}Q^p_1 & Q^p_2 & Q^p_3\end{pmatrix}
  \begin{pmatrix}\cola{U}\\ \colb{V}\\ \chi \end{pmatrix}^{(n)} \nonumber
\end{eqnarray}


\begin{eqnarray}
  \label{eq:field_advance}
  \lefteqn{
  \begin{pmatrix}
    \cola{S^B_{1 1}} & \colb{S^B_{1 2}} & S^B_{1 3}\\
    \colb{S^B_{2 1}} & \colb{S^B_{2 2}} & S^B_{2 3}\\
          S^B_{3 1}  &       S^B_{3 2}  & S^B_{3 3}\\
  \end{pmatrix} 
  \begin{pmatrix}
    \cola{\psi}\\ \colb{F}\\ p_e
  \end{pmatrix}^{(n+1)}}\\
  & = & 
  \begin{pmatrix}
    \cola{D^B_{1 1}} & \colb{D^B_{1 2}} & D^B_{1 3}\\
    \colb{D^B_{2 1}} & \colb{D^B_{2 2}} & D^B_{2 3}\\
          D^B_{3 1}  &       D^B_{3 2}  & D^B_{3 3}\\
  \end{pmatrix} 
  \begin{pmatrix}
    \cola{\psi}\\ \colb{F}\\ p_e
  \end{pmatrix}^{(n)} +
  \begin{pmatrix}
    \cola{R^B_{1 1}} & \colb{R^B_{1 2}} & R^B_{1 3}\\
    \colb{R^B_{2 1}} & \colb{R^B_{2 2}} & R^B_{2 3}\\
          R^B_{3 1}  &       R^B_{3 2}  & R^B_{3 3}\\
  \end{pmatrix} 
  \begin{pmatrix}
    \cola{U}\\ \colb{V}\\ \chi
  \end{pmatrix}^{(n+1)} \nonumber
  \\ & & \mbox{} +
  \begin{pmatrix}
    \cola{Q^B_{1 1}} & \colb{Q^B_{1 2}} & Q^B_{1 3}\\
    \colb{Q^B_{2 1}} & \colb{Q^B_{2 2}} & Q^B_{2 3}\\
          Q^B_{3 1}  &       Q^B_{3 2}  & Q^B_{3 3}\\
  \end{pmatrix} 
  \begin{pmatrix}
    \cola{U}\\ \colb{V}\\ \chi
  \end{pmatrix}^{(n)} +
  \begin{pmatrix}
    \cola{O^B_{1}}\\
    \colb{O^B_{2}}\\
          O^B_{3} \\
  \end{pmatrix} \nonumber
\end{eqnarray}

\subsubsection{Linear Calculations}

Linear calculations may be performed by calculating each matrix once,
and recalculating the matrix-vector products each time step with the
updated vectors.  This method is very efficient because the $S$
matrices need only be inverted once, and in all subsequent time steps
the only matrix operations carried out are addition and matrix-vector
multiplication.  Non-linear simulations require all the matrices to be
recalculated each time step, and the $S$ matrices must be inverted
each time step.

\subsubsection{Implementation of Electron Pressure Equation}

Because it is the electron pressure which appears in the generalized
Ohm's law, equation~(\ref{eq:ohm}), if the electron pressure equation
is retained, it is solved with the magnetic field as the third row in
equation~(\ref{eq:field_advance}) so as to keep the fast magnetosonic
wave implicit.  In this case, the full pressure is evolved
independently in equation~(\ref{eq:pressure_advance}).  If the
electron pressure equation is not included, the third row in
equation~(\ref{eq:field_advance}) is the total pressure equation, and
the electron pressure is assumed to remain always at a specific
fraction of the total pressure, which is determined by the initial
conditions.


\subsection{Crank-Nicholson}

The Crank-Nicholson time step is defined by the following discretization:
\begin{eqnarray*}
  \frac{\partial U}{\partial t} & \to & 
  \frac{U^{(n+1)} - U^{(n)}}{\dt}\\
  U & \to & \thimp U^{(n+1)} + (1-\thimp) U^{(n)}.
\end{eqnarray*}
By Taylor expanding about $U$,
\begin{eqnarray*}
  U^{(n+1)} & = & U + \thimp\,\dt\,\dot{U} + \frac{1}{2} \thimp^2 \dt^2
  \ddot{U} + \frac{1}{6} \thimp^3 \dt^3 \dddot{U}+ \cdots
  \\
  U^{(n)} & = & U + (\thimp-1) \dt\, \dot{U} + \frac{1}{2} (\thimp-1)^2 \dt^2
  \ddot{U} + \frac{1}{6} (\thimp-1)^3 \dt^3 \dddot{U} + \cdots
\end{eqnarray*}
the trunctation error of the time-derivative operator can be
calculated directly:
\begin{eqnarray*}
  \Delta_{CN}(\dt, \thimp) & = & \frac{U^{(n+1)} - U^{(n)}}{\dt} -
 \dot{U}
 \\ 
 & = & 
  \left( \thimp-\frac{1}{2} \right) \dt\,\ddot{U}
  + \frac{1}{2} \left(\thimp^2 - \thimp + \frac{1}{3} \right) \dt^2 \dddot{U}
  + \cdots.
\end{eqnarray*}
When $\thimp=1/2$, the time differencing is ``time-centered'' because
the two points involved in the time differencing are equidistant in
the logical time coordinate from the point at which the field itself
is evaluated.  In this case, the leading-order truncation error is
$\order{\dt^2}$:
\begin{equation}
  \Delta_{CN}(\dt, \thimp=1/2) = \frac{1}{24} \dt^2 \dddot{U} + \cdots.
\end{equation}

\subsection{BDF2}

The BDF2 time step is defined by the following discretization:
\begin{eqnarray*}
  \frac{\partial U}{\partial t} & \to & 
  \frac{3 U^{(n+1)} - 4 U^{(n)} + U^{(n-1)}}{2\,\dt}\\
  U & \to & U^{(n+1)}.
\end{eqnarray*}
Taylor expanding about $U$:
\begin{eqnarray*}
  U^{(n+1)} & = & U
  \\
  U^{(n)} & = & U - \dt\, \dot{U} + \frac{1}{2} \dt^2 \ddot{U} 
  - \frac{1}{6} \dt^3 \dddot{U} + \cdots
  \\
  U^{(n-1)} & = & U - 2\,\dt\, \dot{U} + 2\,\dt^2 \ddot{U} 
  - \frac{4}{3} \dt^3 \dddot{U} + \cdots
\end{eqnarray*}
and the truncation error is
\begin{equation}
  \Delta_{BDF2}(\dt) = 
  \frac{3 U^{(n+1)} - 4 U^{(n)} + U^{(n-1)}}{2\,\dt} - \dot{U} = 
  - \frac{1}{3} \dt^2 \dddot{U}
  + \cdots.
\end{equation}


\chapter{Input Parameters}
\label{sec:input_parameters}

\subsection{Model Options}

\begin{tabular}{llp{3in}}
  \textbf{Option}&\textbf{Default}&\textbf{Description}\\
  \hline
  \texttt{numvar} & 3   & MHD model. 1: 2-field;  2: 4-Field;  3: 6-Field.\\
  \texttt{idens}  & 1   & 1: include density equation\\
  \texttt{ipres}  & 0   & 1: include electron pressure equation\\
  \texttt{gyro}   & 0   & 1: include gyroviscous term\\
  \texttt{itor}   & 0   & 0: cartesian; 1: cylindrical\\
  \texttt{linear} & 0   & 1: linear (perturbation terms only, no matrix
                              recalculation)\\
  \texttt{eqsubtract}& 0& 1: remove equilibrium terms from equations\\
  \texttt{isource}   & 0& 1: include ``source'' terms in velocity
    advance\\
  \texttt{igauge} & 0   & 1: Loop voltage appears explicitly in Ohm's law.\\
  \texttt{ntor}   & 0   & The toroidal modenumber of linear perturbations in
                          complex simulations.\\
  \texttt{istatic}& 0   & 1: Do not advance velocity\\
  \texttt{iestatic}&0   & 1: Do not advance magnetic fields\\
  \texttt{inertia} & 1  & 1: Include $\u \cdot \grad{\u}$ terms\\
  \texttt{itwofluid}& 1 & 1: Include $\j\times\B$ and
  $\grad{p_e}$ terms in Ohm's law\\ 
\end{tabular}


\subsection{Physical Parameters}

\begin{tabular}{llcl}
  \textbf{Option}&\textbf{Var.}&\textbf{Default}&\textbf{Description}\\
  \hline
  \texttt{gam}    & $\Gamma$& 5/3 & Adiabatic constant\\
  \texttt{db}     & $d_i$   & 0   & Ion skin depth\\
  \texttt{gravr}, \texttt{gravz} & \vec{g} & 0 & \parbox[t]{1.8in}{Gravity.\\
                       $\vec{g} = -(\mathtt{gravr}/R^2) \uvec{R} 
                                  - \mathtt{gravz}\ \uvec{Z}$.}
\end{tabular}


\subsection{Transport Coefficients}

\begin{tabular}{llcp{2.25in}}
  \textbf{Option}&\textbf{Var.}&\textbf{Default}&\textbf{Description}\\
  \hline
  \texttt{denm}      & $D_n$   & 0   & Density diffusion coefficient\\
  \hline
  \texttt{amu}       & $\mu_r$       & 0 & \\
  \texttt{amu\_edge} & $\mu_0$       & 0 & \\
  \texttt{amuoff}    & $\Psi_c^\mu$ & 0 & \\
  \texttt{amudelt}   & $\Delta^\mu$ & 0 & \\
  \texttt{iresfunc} & & 0 &
  \begin{minipage}[t]{2.2in}
    0: $\mu = \mu_r$\\
    2: $\mu = \mu_r + \frac{1}{2}\mu_0 \{1 + \tanh[(\Psi - \Psi_c^{\mu})/\Delta^{\mu}]\}$\\
    3: $\mu = \mu_r + \eta_0 H(\Psi - \Psi_c^{\mu})$\\
  \end{minipage}\\  
  \texttt{amuc}   & $\mu_c$ & $\mu_r$ & Compressional viscosity coefficient\\
  \texttt{amupar} & $\mu_\parallel$ & 0 & Parallel viscosity coefficient\\
  \hline
  \texttt{etar}   & $\eta_r$   & 0 & \\
  \texttt{eta0}   & $\eta_0$ & 0 & \\
  \texttt{etaoff} & $\Psi_c^\eta$ & 0 & \\
  \texttt{etadelt}& $\Delta^\eta$ & 0 & \\
  \texttt{iresfunc} & & 0 &
  \begin{minipage}[t]{2.2in}
    0: $\eta = \eta_r + \eta_0/T_e^{3/2}$\\
    2: $\eta = \eta_r + \frac{1}{2}\eta_0 \{1 + \tanh[(\Psi - \Psi_c^{\eta})/\Delta^{\eta}]\}$\\
    3: $\eta = \eta_r + \eta_0 H(\Psi - \Psi_c^{\eta})$\\
    4: $\eta = \eta_{Spitzer}$
  \end{minipage}\\
  \hline
  \texttt{kappat}   & $\eta_t$    & 0 & \\
  \texttt{kappa0}   & $\eta_0$    & 0 & \\
  \texttt{kappaoff} & $\Psi_c^\kappa$ & 0 & \\
  \texttt{kappadelt}& $\Delta^\kappa$ & 0 & \\
  \texttt{iresfunc} & & 0 &
  \begin{minipage}[t]{2.2in}
    0: $\kappa = \kappa_t + \kappa_0*p/T^{3/2}$\\
    2: $\kappa = \kappa_t + \frac{1}{2}\kappa_0 \{1 + \tanh[(\Psi - \Psi_c^{\kappa})/\Delta^{\kappa}]\}$
  \end{minipage}\\
  \texttt{kappar} & $\kappa_\parallel$ & 0 
                  & Parallel thermal conductivity\\
  \texttt{ikapscale}& & 0 & 1: Multiply \texttt{kappar} by $\kappa$\\
  \texttt{kappax} & $\kappa_\times$ & 0 
                  & Crosswise thermal conductivity\\ 
\end{tabular}

\subsection{Hyper-Diffusivity}

\begin{tabular}{lcp{2.2in}}
  \textbf{Option} & \textbf{Default} & \textbf{Description}\\
  \hline
  \texttt{xzero}  & 0 & $R$-coordinate of bottom left corner of domain\\
  \texttt{zzero}  & 0 & $Z$-coordinate of bottom left corder of domain\\
  \texttt{iper}   & 0 & 1: Left/right boundaries periodic\\
  \texttt{jper}   & 0 & 2: Top/bottom boundaries periodic\\
  \texttt{inonormalflow}& 1 & 1: No-normal-flow boundary\\
  \texttt{inoslip\_pol} & 0 & 1: No-slip boundaries for poloidal velocity\\
  \texttt{inoslip\_tor} & 1 & 1: No-slip boundaries for toroidal velocity\\
  \texttt{inostress\_tor}&0 & 1: No-normal-stress boundary for toroidal 
                                 velocity\\
  \texttt{com\_bc}& 1 & 1: $\nabla^2 \chi = 0$\\
  \texttt{iconst\_t}  & 0 & 0: $\partial_t T = 0$\\
  \texttt{inograd\_t} & 0 & 0: No normal temperature gradient\\
  \texttt{vloop}  & 0 & Loop voltage.  $\partial_t \psi = \mathtt{vloop}$\\
  \texttt{imask}  & 0 & 1: Smoothly bring $d_i$ to zero near
    boundaries\\
  \texttt{amu\_edge} & 0 &    Factor by which to increase viscosity near 
                              boundaries
\end{tabular}


\subsection{Time Integration Options}
\begin{tabular}{lcp{3in}}
  \textbf{Option}&\textbf{Default}&\textbf{Description}\\
  \hline
  \texttt{dt}         & 0.1 & Time step\\
  \texttt{ntimemax}   & 20  & Total number of time steps\\
  \texttt{integrator} & 0   & 0: Crank-Nicholson (CN); 1: BDF2\\
  \texttt{imp\_mod}   & 0   & 
  \begin{minipage}[t]{3in}
    0: $\theta$-implicit\\
    1: Implicit leapfrof (\texttt{isplitstep} = 1 only)\\
  \end{minipage}\\
  \texttt{thimp}      & 0.5 & Implicitness parameter\\
  \texttt{thimp\_ohm} & \texttt{thimp} & 
                              Implicitness of ohmic heating terms\\
  \texttt{thimpsm}    & 1   & Implicitness of the smoother functions\\
  \texttt{isplitstep} & 1   & 0: Fully implicit time step; 
                              1: split time step.\\
  \texttt{iresolve}   & 0   & 1: Re-solve velocity after 
                              field advance of split time step.\\
  \texttt{iteratephi} & 0   & 1: Calculate transport coefficients after
    field advance, then recalculate field advance.
\end{tabular}


\subsection{Spatial Integration Options}
\begin{tabular}{lcp{3in}}
  \textbf{Option}&\textbf{Default}&\textbf{Description}\\
  \hline
  \texttt{int\_pts\_main}  & 79 & Sampling points for integrations in
                                main time step matrices\\
  \texttt{int\_pts\_aux}   & 79 & Sampling points for integrations in
                                calculations of auxiliary variables\\
  \texttt{int\_pts\_diag}  & 79 & Sampling points for integrations in
                                diagnostic calculations\\
\end{tabular}


\subsection{Numerical Options}
\begin{tabular}{llp{3in}}
  \textbf{Option}&\textbf{Default}&\textbf{Description}\\
  \hline
  \texttt{ivform} & 0   & 0: $\u = \grad{U}\times\grad{\tor} + V
   \grad{\tor} + \grad{\chi}$\\
   & & 1: $\u = \r^2 \grad{U}\times\grad{\tor} + \r^2 \omega
   \grad{\tor} + \r^{-2} \grad{\chi}$\\
  \texttt{jadv}   & 0   & 1: Use toroidal current density equation
                          instead of poloidal flux equation.\\
  \texttt{max\_ke}& 1.0  & Maximum value of kinetic energy before solution is
                          rescaled in linear simulations. (0 = don't rescale)\\
  \texttt{harned\_mikic} & 0.0 & Coefficient of Harned-Mikic two-fluid
                          stabilization term.\\
\end{tabular}

\subsection{Input/Output Options}

\begin{tabular}{lcp{2.7in}}
  \textbf{Option}&\textbf{Default}&\textbf{Description}\\
  \hline
  \texttt{ntimepr}   & 5 & Number of timesteps per full field output\\
  \texttt{iprint}    & 0 & 1: Print detailed info to stdout\\
  \texttt{iglobalout}& 0 & 1: Write process-independent output file\\
  \texttt{iglobalin} & 0 & 1: Read process-independent output file on restart\\
  \texttt{irestart}  & 0 & 1: Read restart file\\
  \texttt{iread\_eqdsk}   & 0 & 1: Read EFIT g-file 'geqdsk'\\
  \texttt{iread\_dskbal}  & 0 & 1: Read BAL file 'dskbal'\\
  \texttt{iread\_jsolver} & 0 & 1: Read Jsolver file 'fixed'
\end{tabular}


\subsection{Initial Conditions Options}

\begin{tabular}{llcp{2.5in}}
  \textbf{Option}&\textbf{Var.}&\textbf{Default}&\textbf{Description}\\
  \hline
  \texttt{itaylor} & & 0 & \begin{minipage}[t]{2.5in}
    Pre-defined initial conditions.\\
    0: Tilting cylinder\\
    1: Taylor Reconnection\\
    2: Force-Free equilibrium\\
    3: GEM Reconnection\\
    4: Wave Propagation\\
    5: Gravitational Instability\\
  \end{minipage}\\
  \texttt{irmp} & & 0 & 
  \begin{minipage}[t]{2.5in}
    Add nonaxisymmetric perturbation from
    \texttt{rmp\_coil.dat} and \texttt{rmp\_current.dat} with $n =
    \mathtt{ntor}$\\
    1: Initial perturbation is vacuum field\\
    2: Perturbation only at boundary
  \end{minipage}\\
  \texttt{maxn}     & & 200 & Maximum wavenumber of initial random noise\\
  \texttt{eps}      & & 0.01 & Size of random perturbation\\
  \texttt{iflip}    & & 0 & 1: Flip coordinate system handedness\\
  \texttt{iflip\_b} & & 0 & 1: Flip sign of toroidal field\\
  \texttt{iflip\_v} & & 0 & 1: Flip sign of toroidal velocity\\
  \texttt{icsym}    & & 0 &
  \begin{minipage}[t]{2.5in}
    Impose symmetry on random perturbations
    0: No symmetry\\
    1: Odd up-down symmetry (in $U$)\\
    2: Even up-down symmetry (in $U$)
  \end{minipage}\\
  \texttt{bscale}      & & 1.0 & Bateman scaling for toroidal field\\
  \hline
  \texttt{den\_edge}   & $\rho_e$      & 0.0 & \\
  \texttt{den0}        & $\rho_0$      & 1.0 & \\
  \texttt{denoff}      & $\Psi_c^\rho$ & 1.0 & \\
  \texttt{dendelt}     & $\Delta^\rho$ & 0.1 & \\
  \texttt{idenfunc}    &               & 0   &
  \begin{minipage}[t]{2.5in}
    0: Use problem-specific density\\
    2: $\rho = \rho_0 + \frac{1}{2}\rho_e \{1 + \tanh[(\Psi - \Psi_c^{\rho})/\Delta^{\rho}]\}$\\
    3: $\rho = \rho_0 + \rho_e H(\Psi - \Psi_c^{\rho})$\\
    4: Read density profile from 'PROFDEN.txt'
  \end{minipage}
\end{tabular}

\subsection{Grad-Shafranov Solver Options}
\begin{tabular}{lcp{3in}}
  \textbf{Option}&\textbf{Default}&\textbf{Description}\\
  \hline
  \texttt{igs}   & 80     & Number of Picard iterations\\
  \texttt{xmag}  & \texttt{xzero}+1 & $R$-coordinate of magnetic axis\\
  \texttt{zmag}  & 0      & $Z$-coordinate of magnetic axis\\
  \texttt{xlim}  & \texttt{xzero}   & $R$-coordinate of limiter\\
  \texttt{zlim}  & 0      & $Z$-coordinate of limiter\\
  \hline
  \texttt{divertors} & 0  & Number of divertors (0--2)\\
  \texttt{divcur}& 0.1    & Divertor current(s), as fraction of tcuro\\
  \texttt{xdiv}  & 0      & $r$-coordinate of divertor current(s)\\
  \texttt{zdiv}  & 0      & \parbox[t]{3in}{$z$-coordinate of 
    divertor 
    current.  If $\mathtt{divertors} = 2$, the second divertor has 
    $z = -\mathtt{zdiv}$.}\\
  \hline
  \texttt{tcuro} & 1      & Plasma current in GS equilibrium\\
  \texttt{q0}    & 1      & Safety factor at magnetic axis\\
  \texttt{djdpsi}& 0      & $J_\tor'(\Psi)$ at magnetic axis\\
  \texttt{bzero} & 1      & $B_\tor$ at \texttt{rzero}\\
  \texttt{pedge} & 0      & Pressure in vacuum region\\
  \texttt{p0}    & 0.01   & Pressure at magnetic axis\\
  \texttt{p1}    & -1     & $p'(\Psi)$ at magnetic axis\\
  \texttt{p2}    & -2     & $p''(\Psi)$ at magnetic axis\\
  \texttt{pedge} & 0      & Pressure in vacuum region\\
  \texttt{divertors} & 0  & Number of divertors (0--2)\\
  \texttt{divcur}& 0.1    & Divertor current(s), as fraction of tcuro\\
  \texttt{xdiv}  & \texttt{xmag} & $R$-coordinate of divertor current(s)\\
  \texttt{zdiv}  & \texttt{zmag} & \parbox[t]{3in}{$Z$-coordinate of 
    divertor 
    current.  If $\mathtt{divertors} = 2$, the second divertor has 
    $Z = -\mathtt{zdiv}$.}\\
  \texttt{expn}  & 0 & \parbox[t]{3in}{Fraction of pressure gradient due to
    density gradient: $n = p^\mathtt{expn}$.}\\
  \texttt{psiscale} & 1.0 & Rescale profiles s.t. LCFS is at 
  $\Psi=\mathtt{psiscale}$.
\end{tabular}



\subsection{Boundary and Domain Options}

\begin{tabular}{lcp{2.5in}}
  \textbf{Option} & \textbf{Default} & \textbf{Description}\\
  \hline
  \texttt{xzero}  & 0 & $r$-coordinate of bottom left corner of domain\\
  \texttt{zzero}  & 0 & $z$-coordinate of bottom left corder of domain\\
  \texttt{iper}   & 0 & 1: Left/right boundaries periodic\\
  \texttt{jper}   & 0 & 2: Top/bottom boundaries periodic\\
  \hline
  \texttt{ifixedb} & 0 & Set $\psi=0$ on boundary\\
  \texttt{inonormalflow}& 1 & 1: No-normal-flow boundary\\
  \texttt{inoslip\_pol} & 0 & 1: No-slip boundaries for poloidal velocity\\
  \texttt{inoslip\_tor} & 1 & 1: No-slip boundaries for toroidal velocity\\
  \texttt{inostress\_tor}&0 & 1: No-normal-stress boundary for toroidal 
                                 velocity\\
  \texttt{iconst\_bz} & 1 & 1: Toroidal field held constant on boundary\\
  \texttt{iconst\_n}  & 0 & 1: Density held constant on boundary\\
  \texttt{iconst\_p}  & 1 & 1: Pressure held constant on boundary\\
  \texttt{iconst\_t}  & 0 & 1: Temperature held constant on boundary\\
  \texttt{inograd\_p} & 0 & 1: No normal pressure gradient\\
  \texttt{inograd\_t} & 0 & 1: No normal temperature gradient\\
  \texttt{com\_bc}& 0 & 1: $\nabla^2 \chi = 0$\\
  \texttt{vor\_bc}& 0 & 1: $\Delta^* U = 0$\\
  \texttt{imask}  & 0 & 1: Smoothly bring $d_i$ to zero near
    boundaries\\
  \hline
  \texttt{eta\_wall}   & 0 & Resistivity of the wall\\
  \texttt{delta\_wall} & 1 & Thickness of the resistive wall
\end{tabular}



\subsection{Unit Normalizations}
\begin{tabular}{lcp{3in}}
  \textbf{Option}&\textbf{Default}&\textbf{Description}\\
  \hline
  \texttt{n0\_norm} & $10^{14}$ & Density normalization (in cgs)\\
  \texttt{b0\_norm} & $10^4$    & Magnetic field normalization (in cgs)\\
  \texttt{l0\_norm} & $100$     & Length normalization (in cgs)
\end{tabular}


\subsection{Current Controller Options}

\begin{tabular}{llcl}
  \textbf{Option}&\textbf{Var.}&\textbf{Default}&\textbf{Description}\\
  \hline
  \texttt{vloop}      & $V_L$ & 0              & (Initial) loop voltage.\\
  \texttt{tcur}       & $I_0$ & \texttt{tcuro} & Target toroidal current\\
  \texttt{control\_p} & $c_p$ & 0              & Proportional coefficient\\
  \texttt{control\_i} & $c_i$ & 0              & Integral coefficient\\
  \texttt{control\_d} & $c_d$ & 0              & Derivative coefficient\\
\end{tabular}


\subsection{Density Source Options}

\begin{tabular}{llcp{2in}}
  \textbf{Option}&\textbf{Var.}&\textbf{Default}&\textbf{Description}\\
  \hline
  \texttt{ipellet}      & & 0    & 1: include pellet density
    source (\textit{c.f.} section~\ref{sec:pellet_injection})\\
  \texttt{pellet\_rate} & $\alpha_p$ & 0 
                                     & Particle number injection rate\\
  \texttt{pellet\_var}  & $l_p$      & 1    & Variance of  
                                              injection profile\\
  \texttt{pellet\_x}    & $R_p$      & \texttt{xmag} 
                                     & $R$-coordinate of injection profile\\
  \texttt{pellet\_z}    & $Z_p$      & \texttt{zmag} 
                                     & $Z$-coordinate of injection profile\\
  \texttt{ionization}   & & 0  & 1: include neutral ionization
    source (\textit{c.f.} section~\ref{sec:ionization})\\
  \texttt{ionization\_rate} & $\alpha_i$ & 0 
                                     & Ionization rate coefficient\\
  \texttt{ionization\_temp} & $E_i$   & 0.01 & Ionization energy\\
  \texttt{ionization\_depth}& $l_i$   & 0.01 & Temperature 
    scale-length of neutral burn-out
\end{tabular}


\subsection{Diagnostics Options}

\begin{tabular}{lcp{3in}}
  \textbf{Option}&\textbf{Default}&\textbf{Description}\\
  \hline
  \texttt{xnull}     & 0 & Guess for $r$-coordinate of x-point\\
  \texttt{znull}     & 0 & Guess for $z$-coordinate of x-point\\
  \texttt{icalc\_scalars} & 1 & 1: Calculate volume-integrated scalars 
                                (\textit{e.g.} energy)\\
  \texttt{ike\_only} & 0 & 1: Only calculate kinetic energy
\end{tabular}



\bibliographystyle{plain}
\bibliography{doc.bib}

\appendix

\include{idl_postprocessor}

\end{document}
