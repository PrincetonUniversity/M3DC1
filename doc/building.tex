\section{Download and Compilation}

\subsection{Accessing PPPL Machines}

Once you obtain a PPPL Unix user account, please visit the website:   http://researchcomputing.pppl.gov
\\
There, you will find instructions for installing NX virtual Desktop.
\\
In PPPL machine, first get an interactive session for a single processor on the “portal” computer.    The M3DC1 code is located in the Github repository: PrincetonUniversity/M3DC1. Access to this repository requires a Github account and permission from nferraro@pppl.gov.   Note that Section 1.5 describes how to use pre-compiled versions of M3D-C1 so you do not need githup access.

\subsection{Getting Source}
\subsubsection{Github}

Retrieve the current version of M3D-C1 from the GIT repository.  For the first time, to check out the sources do:
\\
Initial access is with the “clone” command.   This copies the source code from the master file into a working directory on your machine.   You only do this once on each computer you work on.
\\
\texttt{module load git
}
\\
git clone https://github.com/PrincetonUniversity/M3DC1
\newline\newline
Subsequent GIT commands used to commit:
\\
\texttt{add/commit/push}\\
you add files to a list of files to update, commit the changes to your branch, and then push the changes to the master branch
\\
\texttt{git commit –m “message describing changes”}
\\
add –a commits all changes
\\
diff lists the changes you made from the last commit, even if you haven’t pushed your commits to github.    To see how your files differ from what’s on github, you can do:
\\
\texttt{		git fetch origin master
}
\\
\texttt{
		git diff origin/master
}
\\
status compares your branch with the “master branch”
\\
pull updates your local branch to the current master branch
\\
	may need to origin master
\\
stash takes uncommitted changes, saves them for later use, and reverts files in working directory
\texttt{
	stash list	stash drop	stash apply	stash pop (apply+drop)
}
\\
\texttt{stash pop} removes changes from your stash and reapplies them to working copy
\\
\texttt{stash apply} keeps changes in stash, but reapplies them to working copy
\\
\texttt{reset –hard} discards any changes to local branch since last commit
\\
branch tells you what branch you are in
\\
\texttt{log (--oneline) (--after 2017-12-31)} lists all the commits for the checked-out branch after that date
\\
\texttt{
checkout b8d17c0} switches to commit branch b8d17c0

\subsubsection{Branches in git}

To make a new branch called fp\_phase2
\\
======================================
\\
\texttt{> git checkout master                      \# switch to the master branch}
\\
\texttt{> git pull
                                 \# make sure the master branch is up-to-date
}
\\
\texttt{> git checkout -b fp\_phase2                \# The "-b" create a new branch
}
\\
\texttt{
                                           \#   this will be identical to master to start
}
\\
\texttt{> git push --set-upstream origin fp\_phase2 \# push this new branch to the remote repo so others can access it
}
\\

Committing changes (e.g., newpar.f90)
\\
======================================
\\
\texttt{> git pull                           \# Always do this before you start committing
}
\\
                                     \#   if you forget, you risk diverging your local branch from remote
\\
\texttt{> git add newpar.f90                 \# This stages the current changes in newpar.f90 for commit
}
\\
                                     \#   you could then make more changes before committing,
\\
                                     \#   but you'd have to add again to get those into the commit
\\
\texttt{> git commit -m "Changed newpar.f90" \# Commit changes to your local branch 
}
\\
\texttt{> git push                           \# Push commits to the remote repo
}
\\
                                     \#   --set-upstream only needs to be done the first time
\\

Merge changes on master into fp\_phase2 (e.g., some important bug fix)
\\
======================================
\\
\texttt{> git checkout master    \# switch to the master branch
}
\\
\texttt{> git pull               \# get the latest commits on the master branch
}
\\
\texttt{> git checkout fp\_phase2 \# switch back to fp\_phase2 (no need for -b now)
}
\\
\texttt{> git pull               \# get latest commits on fp\_phase2 to avoid conflicts
}
\\
\texttt{
> git merge master       \# merge any new commits into fp\_phase2
}
\\
                         \#  - this makes a commit
\\
                         \#  - you may need to resolve conflicts
\\
\texttt{> git push               \# push the merge commit to remote repo
}
\\

Inverting fp\_phase2 and master here would merge the development branch into master locally, then the push would send the merge to the remote master.

\subsection{On-line Documentation}
An extensive document that describes equations solved by the code and the input variables in C1input is in the GIT repo. Please refer to:
\\
\texttt{…./trunk/unstructured/doc/doc.pdf}
\newline\newline
Machine-specific instructions for portal, perseus, Edison, Cori are in:  
\texttt{…/trunk/unstructured/README}
\newline\newline
Additional documentation is available on the site:  w3.pppl.gov/~nferraro under the “M3D-C1” tab.
\newline\newline
The latest copy of his document is available at: http://m3dc1.pppl.gov

\subsection{Compilation}
\subsubsection{PPPL RHEL6 machines (portal.pppl.gov)}
\texttt{openmpi-1.8.4}
\\
Load the following modules and copy sunfire.openmpi-1.8.4.mk to sunfire.pppl.gov.mk
\\
\texttt{
openmpi/1.8.4		intel/2015.u1		gsl/1.16			szip/2.1      	hdf5-parallel 
\\
hdf/4.2r1		scalapack		fftw			
}
\\
See README/readme.portalr.openmp-1.8.4 for detailed instructions and an example job script
\texttt{openmpi-1.10.3}
\\
Load the following modules and copy sunfire.openmpi-1.10.3.mk to sunfire.pppl.gov.mk
\\
\texttt{openmpi/1.10.3	intel/2015.u1		gsl		szip                     	hdf5-parallel/1.8.17 
}
\\
See README/readme.portal.openmp-1.10.3 for detailed instructions and an example job script.

\texttt{openmpi-4.0.1}
\\
Load the following modules and copy sunfire.openmpi-1.10.3.mk to sunfire.pppl.gov.mk
\texttt{
openmpi/4.0.1		intel/2019.u3		gsl		szip                     	scalapack 
}\\
See README/readme.portal.openmp-4.0.1 for detailed instructions and an example job script
\subsubsection{PPPL RHEL7 machines (portalc7.pppl.gov)}
Load the following modules and copy centos7.mk to sunfire.pppl.gov.mk
\texttt{openmpi/4.0.3		intel/2019.u3		hdf5-parallel/1.10.5 
}\\
See README/readme.centos7 for detailed instructions and an example job script.

\texttt{cori.nersc.gov 
}\\
See README/readme.cori and README/readme.corigpu for detailed instructions and an example job script.

\texttt{perseus.princeton.edu}
\\
Follow the instructions in 5.1.1 in first setting up idl 
\\
Load the following modules:
\\
\texttt{intel/18.0/64/18.0.3.222		intel-mpi/intel/2018.3/64		gsl/2.4
hdf5/intel-17.0/intel-mpi/1.10.0	fftw/intel-16.0/intel-mpi/3.3.4
}\\
See README/readme.perseus for detailed instructions and an example job script.
\\
For help regarding perseus, send email to:  cses@princeton.edu

\texttt{perseus-amd.princeton.edu}
\\
Load the following modules:
\texttt{
intel/18.0/64/18.0.3.222		intel-mpi/intel/2018.3/64		gsl
hdf5/intel-17.0/intel-mpi/1.10.0	fftw/intel-16.0/intel-mpi/3.3.4
}\\
See README/readme.perseusamd for detailed instructions and an example job script.
\newline\newline
For help regarding perseus, send email to:  cses@princeton.edu
\texttt{stellar.princeton.edu}
\\
See README/readme.stellar for detailed instructions and an example job script.
\\
For help regarding stellar, send email to:  cses@princeton.edu

\texttt{traverse.princeton.edu}
\\
Load the following modules:
\texttt{pgi/19.9/64		openmpi/pgi-19.9/4.0.3rc1/64 		hdf5/pgi-19.5/openmpi-4.0.2rc1/1.10.5
fftw/gcc/ openmpi-4.0.1/3.3.8		cudatoolkit/10.1
}\\
See README/readme.traverse for detailed instructions and an example job script.
\newline\newline
For help regarding traverse, send email to:  cses@princeton.edu

\subsubsection{Make}
The sources are located in the directory: \texttt{/trunk/unstructured}
\\
By default, M3D-C1 is linked with PETSc and release version of SCOREC libraries.
\\
\begin{description}
\item 	For a 2D nonlinear version of the code:   	make OPT=1 MAX\_PTS=25
\item	For a linear version of the code:               		make OPT=1 COM=1 MAX\_PTS=25
\item	For a 3D nonlinear version of the code:     	make OPT=1 3D=1 MAX\_PTS=60
\end{description}
To compile M3DC1 with debug version of SCOREC libraries for lots of sanity checks and informative print statements, add “SCORECVER=debug” to the make command. Note that debug versions are available only on PPPL and NERSC Cori.
\newline\newline
The executable files are located in a sub-directory that is named with an underscore followed by the host name and compile options. For a host name “xxxx”, these commands will generate a folder and an executable file as the following, respectively.
\begin{description}
\item \_xxxx-opt-25/m3dc1\_2d
\item	\_xxxx-complex-opt-25/m3dc1\_2d\_complex
\item \_xxxx-3d-opt-60/m3dc1\_3d
\end{description}
A Tip for “MAX\_PTS”:  All the M3D-C1 control parameters are described in the file “C1input” and the file “C1input” should exist in the work folder where the simulation runs. The C1input parameters “int\_pts\_main”, “int\_pts\_aux”, and “int\_pts\_diag” must be the same or less than MAX\_PTS.

\subsection{Pre-installed release}
An alternative to compiling the code yourself, you can use a pre-installed release version of M3D-C1.    The following instructions for using the modules are taken from the “Tutorial” document linked from https://w3.pppl.gov/~nferraro/m3dc1.html
On the PPPL cluster, load the following modules:
\\
\texttt{module use /p/m3dc1/modules
\\
module load m3dc1/1.11
}

Release versions of m3D-C1 have also been installed on a number of other systems.   The location of the M3D-C1 modules for each of these systems is:
\begin{itemize}
\item	PPPL Cluster:	module use /p/m3dc1/modules
\item	NERSC Cori:	module use /project/projectdirs/mp288/C1/modules/cori
\begin{itemize}
\item		Phase 1: module load m3dc1/1.11-haswell
\item		Phase 2: module load m3dc1/1.11-knl
\end{itemize}
\item	Princeton stellar:	module use /home/nferraro/modules
\item	GA Iris:		module use /fusion/projects/codes/m3dc1/modules
\end{itemize}
\subsection{Regression Tests}
This section describes how to run regression tests for Personal Version (example for cori\_knl)
\begin{enumerate}
\item compile all versions from …/unstructured  (OPT=1, OPT=1 COM=1, OPT=1 3D=1 MAX\_PTS=60)
\item export M3DC1\_MPIRUN=srun M3DC1\_VERSION=local M3DC1\_ARCH=cori\_knl
	(other M3DC1\_MPIRUN=mpiexec, other M3DC1\_ARCH=stellar, centos7,m3dc1 ,cori)
\item from …/unstructured  “make bin”
\item \texttt{PATH=$PATH\: ./unstructured/$M3DC1\_ARCH/bin}
\item 
\begin{description}
\item cd regtest
\item	./clean cori\_knl
\item	./run cori\_knl	(wait until jobs finish)
\item	./check cori\_knl
\end{description}
\end{enumerate}

NOTE:  On some machines, such as cori, there is a limit as to the number of jobs that can be submitted to the debug queue.   In this case, you need to wait until one job finishes, and submit the remaining job(s) manually by the command (for KPRAD\_restart):
\texttt{./run cori\_knl KPRAD\_restart}

